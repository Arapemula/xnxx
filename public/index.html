<!DOCTYPE html>
<html lang="id">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>NayooAI Dashboard</title>
  <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <script src="/socket.io/socket.io.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap"
    rel="stylesheet" />

  <script src="https://cdn.tailwindcss.com"></script>

  <link rel="stylesheet" href="/css/style.css" />
</head>

<body class="h-screen h-[100dvh] flex flex-col overflow-hidden" x-data="app()">
  <!-- Toast Container -->
  <div id="toast-container" class="toast-container"></div>

  <div x-show="!isLoggedIn" x-transition class="fixed inset-0 z-50 bg-gray-900 flex items-center justify-center p-4">
    <div class="glass-panel rounded-2xl w-full max-w-md p-8 text-center shadow-2xl">
      <h1 class="text-2xl font-bold text-gray-800 mb-2">Koneksi WhatsApp</h1>
      <p class="text-gray-600 mb-6">
        ID Sesi:
        <span class="font-mono font-bold bg-gray-100 px-2 py-1 rounded" x-text="sessionId"></span>
      </p>

      <button @click="startAuth" :disabled="isLoading"
        class="w-full bg-green-600 text-white font-bold py-3 rounded-lg hover:bg-green-700 transition disabled:opacity-50 mb-4">
        <span x-text="isLoading ? 'Menghubungkan...' : (qrCodeVal ? 'Scan QR Code' : 'Mulai Koneksi')"></span>
      </button>

      <button @click="logout" class="text-sm text-red-500 hover:underline">
        Logout / Ganti Akun
      </button>

      <div x-show="qrCodeVal" class="my-4 flex flex-col items-center">
        <div id="qrcode-container" class="border-4 border-white shadow-lg rounded-lg"></div>
      </div>
    </div>
  </div>

  <!-- SUBSCRIPTION EXPIRED BLOCKING MODAL -->
  <div x-show="isSubscriptionExpired" x-cloak
    class="fixed inset-0 z-[100] bg-gradient-to-br from-gray-900/95 to-black/98 backdrop-blur-md flex items-center justify-center p-3 sm:p-4 overflow-y-auto">
    <div
      class="glass-panel rounded-2xl sm:rounded-3xl w-full max-w-sm sm:max-w-lg p-5 sm:p-8 text-center shadow-2xl animate-fade-in relative overflow-hidden my-auto">
      <!-- Decorative Elements - Hidden on mobile for performance -->
      <div class="hidden sm:block absolute -top-20 -right-20 w-40 h-40 bg-red-500/20 rounded-full blur-3xl"></div>
      <div class="hidden sm:block absolute -bottom-20 -left-20 w-40 h-40 bg-orange-500/20 rounded-full blur-3xl"></div>

      <!-- Content -->
      <div class="relative z-10">
        <!-- Icon -->
        <div
          class="w-16 h-16 sm:w-24 sm:h-24 mx-auto mb-4 sm:mb-6 bg-gradient-to-br from-red-100 to-orange-100 rounded-full flex items-center justify-center shadow-lg">
          <span class="text-3xl sm:text-5xl">‚è∞</span>
        </div>

        <!-- Title -->
        <h2 class="text-xl sm:text-2xl font-extrabold text-gray-800 mb-2 sm:mb-3">
          Masa Langganan Habis!
        </h2>

        <!-- Description -->
        <p class="text-sm sm:text-base text-gray-600 mb-4 sm:mb-6 leading-relaxed px-2">
          Akses dashboard Anda telah
          <span class="font-bold text-red-600">berakhir</span>. Hubungi
          Developer untuk memperpanjang subscription.
        </p>

        <!-- Expiry Info Box -->
        <div class="bg-red-50 border border-red-200 rounded-xl p-3 sm:p-4 mb-4 sm:mb-6">
          <div class="flex items-center justify-center gap-2 sm:gap-3">
            <span class="text-xl sm:text-2xl">üìÖ</span>
            <div class="text-left">
              <p class="text-[10px] sm:text-xs text-red-600 font-bold uppercase">
                Berakhir
              </p>
              <p class="text-base sm:text-lg font-extrabold text-red-700" x-text="formatExpiryDate()"></p>
            </div>
          </div>
        </div>

        <!-- Contact Info -->
        <div
          class="bg-gradient-to-r from-indigo-50 to-purple-50 border border-indigo-200 rounded-xl p-3 sm:p-4 mb-4 sm:mb-6">
          <p class="text-xs sm:text-sm font-bold text-indigo-800 mb-1 sm:mb-2">
            üìû Hubungi Developer:
          </p>
          <p class="text-sm sm:text-base text-indigo-600 font-medium break-all">
            admin@nayoo.id
          </p>
        </div>

        <!-- Action Buttons -->
        <div class="flex flex-col gap-2 sm:gap-3">
          <a href="https://wa.me/6285218399849?text=min%20mau%20tambah%20langganan%20NayooAI"
            target="_blank"
            class="w-full bg-gradient-to-r from-green-500 to-emerald-600 text-white font-bold py-2.5 sm:py-3 px-4 sm:px-6 rounded-xl hover:shadow-lg hover:shadow-green-300 transition transform active:scale-95 flex items-center justify-center gap-2 text-sm sm:text-base">
            <span>üí¨</span> Hubungi via WhatsApp
          </a>
          <button @click="logout()"
            class="w-full bg-gray-100 text-gray-700 font-bold py-2.5 sm:py-3 px-4 sm:px-6 rounded-xl hover:bg-gray-200 active:bg-gray-300 transition text-sm sm:text-base">
            üö™ Logout / Ganti Akun
          </button>
        </div>
      </div>
    </div>
  </div>

  <div x-show="showPromptModal" x-transition
    class="fixed inset-0 z-50 bg-black bg-opacity-50 flex items-center justify-center p-4" x-cloak>
    <div class="glass-panel rounded-2xl w-full max-w-lg p-6 shadow-2xl relative">
      <button @click="showPromptModal = false" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600">
        ‚úï
      </button>
      <h2 class="text-lg font-bold text-gray-800 mb-2">
        Instruksi AI (Persona)
      </h2>
      <textarea x-model="aiPrompt"
        class="w-full h-32 p-3 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 outline-none resize-none"
        placeholder="Contoh: Kamu adalah Admin..."></textarea>
      <div class="flex justify-end gap-2 mt-4">
        <button @click="showPromptModal = false" class="px-4 py-2 text-gray-600 text-sm hover:bg-gray-100 rounded-lg">
          Batal
        </button>
        <button @click="savePrompt"
          class="px-4 py-2 bg-blue-600 text-white text-sm font-bold rounded-lg hover:bg-blue-700">
          Simpan
        </button>
      </div>
    </div>
  </div>

  <div x-show="isLoggedIn" x-cloak class="flex-1 flex h-full">
    <!-- Mobile Backdrop -->
    <div x-show="mobileMenu" x-transition.opacity @click="mobileMenu = false"
      class="fixed inset-0 z-40 bg-black/50 backdrop-blur-sm md:hidden"></div>

    <aside
      class="w-72 md:w-80 glass-panel flex flex-col h-full z-50 shadow-2xl md:shadow-none absolute md:relative transition-transform duration-300 transform md:translate-x-0"
      :class="mobileMenu ? 'translate-x-0' : '-translate-x-full'">
      <div class="h-16 border-b border-gray-200/50 flex items-center justify-between px-4 bg-white/50 backdrop-blur-sm">
        <div class="flex items-center gap-2">
          <div
            class="w-8 h-8 rounded-full bg-green-100 flex items-center justify-center text-green-700 font-bold text-xs">
            CS
          </div>
          <span class="font-semibold text-gray-700 truncate w-24" x-text="sessionId"></span>
        </div>
        <div class="flex items-center gap-1">
          <button @click="openBroadcastScheduleModal()"
            class="p-1.5 text-gray-400 hover:bg-orange-100 hover:text-orange-600 rounded transition"
            title="Jadwalkan Broadcast">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24"
              stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M11 5.882V19.24a1.76 1.76 0 01-3.417.592l-2.147-6.15M18 13a3 3 0 100-6M5.436 13.683A4.001 4.001 0 017 6h1.832c4.1 0 7.625-1.234 9.168-3v14c-1.543-1.766-5.067-3-9.168-3H7a3.988 3.988 0 01-1.564-.317z" />
            </svg>
          </button>
          <button @click="switchPage('chat')" class="p-1.5 rounded transition"
            :class="currentPage === 'chat' ? 'bg-green-100 text-green-700' : 'text-gray-400 hover:bg-green-100 hover:text-green-600'"
            title="Chat Room">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24"
              stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" />
            </svg>
          </button>
          <button @click="switchPage('analytics')" class="p-1.5 rounded transition"
            :class="currentPage !== 'chat' ? 'bg-blue-100 text-blue-700' : 'text-gray-400 hover:bg-blue-100 hover:text-blue-600'"
            title="Dashboard">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24"
              stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
            </svg>
          </button>
          <button @click="logout" class="p-1.5 text-gray-400 hover:text-red-500 hover:bg-red-50 rounded transition"
            title="Log Out">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24"
              stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
            </svg>
          </button>
        </div>
      </div>

      <div x-show="currentPage !== 'chat'" class="px-4 py-4 border-b border-gray-200/50"
        style="background-color: #f9fafb">
        <nav class="flex flex-col gap-2">
          <button @click="switchPage('analytics')"
            class="flex items-center gap-3 px-4 py-3 rounded-xl text-sm font-semibold transition-all duration-200 group relative overflow-hidden transform hover:-translate-y-1"
            :class="currentPage === 'analytics' ? 'bg-gradient-to-r from-indigo-500 to-indigo-600 text-white shadow-lg shadow-indigo-200' : 'hover:bg-white text-gray-600 hover:shadow-md'">
            <span class="text-lg">üìä</span>
            <span>Dashboard</span>
            <div x-show="currentPage === 'analytics'" class="absolute right-0 top-0 bottom-0 w-1 bg-white/20"></div>
          </button>
          <button @click="switchPage('settings')"
            class="flex items-center gap-3 px-4 py-3 rounded-xl text-sm font-semibold transition-all duration-200 group relative overflow-hidden transform hover:-translate-y-1"
            :class="currentPage === 'settings' ? 'bg-gradient-to-r from-fuchsia-500 to-pink-600 text-white shadow-lg shadow-pink-200' : 'hover:bg-white text-gray-600 hover:shadow-md'">
            <span class="text-lg">‚öôÔ∏è</span>
            <span>Advance Setting</span>
          </button>
          <button @click="switchPage('schedule')"
            class="flex items-center gap-3 px-4 py-3 rounded-xl text-sm font-semibold transition-all duration-200 group relative overflow-hidden transform hover:-translate-y-1"
            :class="currentPage === 'schedule' ? 'bg-gradient-to-r from-cyan-500 to-blue-600 text-white shadow-lg shadow-cyan-200' : 'hover:bg-white text-gray-600 hover:shadow-md'">
            <span class="text-lg">üìÖ</span>
            <span>Live Schedule</span>
          </button>
        </nav>

        <!-- Subscription Countdown Component -->
        <template x-if="userRole === 'USER' && !hideCountdown">
          <div class="mt-4 p-3 rounded-xl bg-gradient-to-r from-indigo-50 to-purple-50 border border-indigo-100">
            <div class="flex items-center justify-between mb-2">
              <span class="text-xs font-bold text-indigo-700 flex items-center gap-1">
                ‚è∞ Sisa Langganan
              </span>
              <button @click="toggleCountdownVisibility()" class="text-xs text-gray-400 hover:text-gray-600">
                Sembunyikan
              </button>
            </div>
            <div class="flex items-center gap-3">
              <div class="relative w-12 h-12">
                <svg class="w-12 h-12 -rotate-90" viewBox="0 0 36 36">
                  <path class="text-gray-200" stroke="currentColor" stroke-width="3" fill="none"
                    d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" />
                  <path :stroke="remainingDays <= 3 ? '#EF4444' : (remainingDays <= 7 ? '#F59E0B' : '#10B981')"
                    stroke-width="3" stroke-linecap="round" fill="none"
                    :stroke-dasharray="(Math.min(remainingDays, 30) / 30 * 100) + ', 100'"
                    d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" />
                </svg>
                <div class="absolute inset-0 flex items-center justify-center">
                  <span class="text-sm font-extrabold text-gray-800" x-text="remainingDays"></span>
                </div>
              </div>
              <div>
                <p class="text-sm font-bold text-gray-800" x-text="remainingDays + ' hari tersisa'"></p>
                <p class="text-[10px] text-gray-500" x-text="'Berakhir: ' + formatExpiryDate()"></p>
              </div>
            </div>
            <template x-if="remainingDays <= 3">
              <p class="text-[10px] text-red-600 font-bold mt-2 animate-pulse">
                ‚ö†Ô∏è Langganan hampir habis! Hubungi Developer untuk perpanjang.
              </p>
            </template>
          </div>
        </template>

        <!-- Hidden Countdown Toggle -->
        <template x-if="userRole === 'USER' && hideCountdown">
          <div class="mt-4">
            <button @click="toggleCountdownVisibility()"
              class="w-full text-xs text-indigo-600 hover:text-indigo-700 font-medium">
              üëÅÔ∏è Tampilkan Info Langganan
            </button>
          </div>
        </template>

        <!-- Developer Link -->
        <template x-if="userRole === 'DEVELOPER'">
          <div class="mt-4 p-3 rounded-xl bg-gradient-to-r from-purple-100 to-pink-100 border border-purple-200">
            <div class="flex items-center justify-between">
              <span class="text-xs font-bold text-purple-700">üëë Mode Developer</span>
              <a href="/developer.html"
                class="text-xs bg-purple-600 hover:bg-purple-700 text-white px-3 py-1 rounded-lg font-bold transition">
                Dashboard Dev
              </a>
            </div>
          </div>
        </template>
      </div>

      <div x-show="currentPage === 'chat'" class="flex-1 flex flex-col overflow-hidden">
        <div class="p-4 bg-blue-50 border-b border-blue-100">
          <div class="flex justify-between items-center mb-3">
            <div class="flex items-center gap-2">
              <span class="text-xs font-bold text-blue-800">AI Auto Reply</span>
              <button @click="showPromptModal = true" class="text-blue-400 hover:text-blue-600">
                <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                </svg>
              </button>
            </div>
            <label class="flex items-center cursor-pointer relative">
              <input type="checkbox" class="sr-only" x-model="aiActive" @change="toggleAI" />
              <div class="w-8 h-4 bg-gray-300 rounded-full transition"
                :class="aiActive ? 'bg-blue-500' : 'bg-gray-300'"></div>
              <div class="dot absolute w-4 h-4 bg-white rounded-full shadow left-0 transition transform"
                :class="aiActive ? 'translate-x-4' : 'translate-x-0'"></div>
            </label>
          </div>
          <div class="flex items-center gap-2">
            <button @click="$refs.excelInput.click()"
              class="flex-1 bg-white border border-blue-200 text-blue-600 text-[10px] font-bold py-1.5 px-2 rounded hover:bg-blue-100 flex items-center justify-center gap-1">
              <span x-text="aiHasFile ? '‚úÖ Excel Ready' : 'üìÇ Upload Produk'"></span>
            </button>
            <input type="file" x-ref="excelInput" @change="uploadExcel" accept=".xlsx, .xls" class="hidden" />
          </div>
        </div>

        <div class="px-4 py-3 border-b border-gray-100 bg-white flex items-center justify-between">
          <span class="text-xs font-bold text-gray-500 uppercase tracking-wider">Chat List</span>
          <label class="flex items-center cursor-pointer text-xs gap-1">
            <input type="checkbox" x-model="showGroups" @change="toggleGroupSettings" class="accent-green-600" />
            <span class="text-gray-500">Grup</span>
          </label>
        </div>

        <div class="flex-1 overflow-y-auto" style="background-color: #f9fafb">
          <template x-for="chat in chatList.filter(c => showGroups ? true : !c.isGroup)" :key="chat.id">
            <div @click="selectChat(chat)"
              class="p-3 mb-2 rounded-xl border border-transparent hover:bg-white/40 cursor-pointer transition-all duration-200 relative group"
              :class="activeChat === chat.id ? 'bg-gradient-to-r from-indigo-50 to-transparent border-l-4 border-l-indigo-500 shadow-md' : 'hover:shadow-sm'">
              <button @click.stop="deleteChat(chat.id)"
                class="absolute right-2 top-2 opacity-0 group-hover:opacity-100 text-gray-400 hover:text-red-500 transition p-1 z-10 bg-white/80 rounded-full shadow-sm backdrop-blur-sm"
                title="Hapus Chat">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24"
                  stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                </svg>
              </button>
              <div class="flex items-center gap-3">
                <div class="relative w-12 h-12 flex-shrink-0">
                  <template x-if="chat.profilePicUrl"><img :src="chat.profilePicUrl"
                      class="w-12 h-12 rounded-full object-cover border-2 border-white shadow-md" /></template>
                  <template x-if="!chat.profilePicUrl">
                    <div
                      class="w-12 h-12 rounded-full bg-gradient-to-tr from-blue-100 to-purple-100 flex items-center justify-center text-blue-600 font-bold text-sm border-2 border-white shadow-md"
                      x-text="getInitials(chat.name)"></div>
                  </template>
                </div>
                <div class="flex-1 overflow-hidden">
                  <div class="flex justify-between items-center mb-0.5">
                    <div class="flex items-center gap-2">
                      <span class="font-bold text-gray-800 text-sm truncate" x-text="chat.name"></span>
                      <span class="text-[9px] px-1.5 py-0.5 rounded font-bold uppercase shadow-sm"
                        :class="getLabelColor(getCRMLabel(chat.id))" x-text="getCRMLabel(chat.id)"></span>
                    </div>
                    <span class="text-[10px] text-gray-400 whitespace-nowrap ml-2 font-medium"
                      x-text="formatTime(chat.timestamp)"></span>
                  </div>
                  <div class="flex justify-between items-center">
                    <p class="text-xs text-gray-500 truncate font-medium" x-text="chat.lastMsg"></p>
                    <span x-show="chat.unread > 0"
                      class="ml-2 bg-gradient-to-r from-red-500 to-pink-500 text-white text-[10px] font-bold px-1.5 py-0.5 rounded-full shadow-sm"
                      x-text="chat.unread"></span>
                  </div>
                </div>
              </div>
            </div>
          </template>
        </div>
      </div>

      <!-- Empty spacer for other pages -->
      <div x-show="currentPage !== 'chat'" class="flex-1 bg-gray-50"></div>
    </aside>

    <main class="flex-1 flex flex-col relative h-full w-full">
      <div class="md:hidden absolute top-4 left-4 z-30" x-show="currentPage !== 'chat' || !activeChat" x-transition>
        <button @click="mobileMenu = !mobileMenu"
          class="glass p-2 rounded-full shadow text-gray-700 hover:text-indigo-600 transition">
          Menu
        </button>
      </div>

      <div x-show="currentPage === 'chat'" class="flex flex-col h-full w-full">
        <div x-show="!activeChat" class="flex-1 flex flex-col items-center justify-center text-gray-400 select-none">
          <h2 class="text-xl font-medium">NayooAI</h2>
          <p class="text-sm mt-2 text-gray-500">
            Pilih chat di sidebar untuk memulai.
          </p>
        </div>

        <div x-show="activeChat"
          class="h-16 glass border-b border-gray-200/50 flex items-center px-4 shadow-sm z-10 justify-between">
          <div class="flex items-center gap-3 md:pl-0">
            <button @click="activeChat = null; mobileMenu = true"
              class="md:hidden p-2 -ml-2 text-gray-600 hover:text-indigo-600 transition">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24"
                stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
              </svg>
            </button>
            <div
              class="w-10 h-10 rounded-full bg-gray-300 flex items-center justify-center overflow-hidden flex-shrink-0 border border-gray-200">
              <template x-if="getActiveChatObj()?.profilePicUrl"><img :src="getActiveChatObj()?.profilePicUrl"
                  class="w-full h-full object-cover" /></template>
              <template x-if="!getActiveChatObj()?.profilePicUrl"><span class="text-gray-600 font-bold text-sm"
                  x-text="getInitials(getActiveChatObj()?.name)"></span></template>
            </div>
            <div>
              <div class="flex items-center gap-2">
                <div class="font-bold text-gray-800 text-sm" x-text="getActiveChatObj()?.name"></div>
                <button @click="showCRMModal = true"
                  class="text-[10px] bg-gray-200 hover:bg-gray-300 text-gray-700 px-2 py-0.5 rounded transition">
                  Edit Label
                </button>
              </div>
              <div class="text-xs text-green-600"
                x-text="getCRMLabel(activeChat) + (getCRMNote(activeChat) ? ' - ' + getCRMNote(activeChat) : '')"></div>
            </div>
          </div>
        </div>

        <div x-show="activeChat" class="flex-1 overflow-y-auto p-4 space-y-4" id="chat-container">
          <template x-for="msg in (activeMessages || [])" :key="msg.id">
            <div class="flex w-full gap-2 group" :class="msg.fromMe ? 'justify-end' : 'justify-start'">
              <button x-show="msg.fromMe" @click="deleteMessage(msg.id)"
                class="opacity-0 group-hover:opacity-100 text-red-400 hover:text-red-600 text-xs self-center px-2 transition">
                üóëÔ∏è
              </button>
              <div x-show="!msg.fromMe" class="flex-shrink-0 flex items-end">
                <template x-if="msg.senderProfilePicUrl"><img :src="msg.senderProfilePicUrl"
                    class="w-8 h-8 rounded-full shadow-sm mb-1 object-cover" /></template>
                <template x-if="!msg.senderProfilePicUrl">
                  <div
                    class="w-8 h-8 rounded-full bg-gray-300 flex items-center justify-center text-[10px] font-bold text-gray-600 mb-1"
                    x-text="getInitials(msg.senderName)"></div>
                </template>
              </div>
              <div class="max-w-[70%] px-4 py-2 text-sm shadow-sm relative flex flex-col"
                :class="msg.fromMe ? 'chat-bubble-me' : 'chat-bubble-other'">
                <div x-show="msg.isGroup && !msg.fromMe" class="text-[10px] font-bold text-orange-600 mb-1"
                  x-text="msg.senderName"></div>
                <template x-if="msg.mediaUrl && msg.mediaType === 'image'">
                  <div class="mb-2">
                    <img :src="msg.mediaUrl"
                      class="rounded-lg w-full max-w-xs object-cover cursor-pointer hover:opacity-90 transition"
                      @click="window.open(msg.mediaUrl, '_blank')" />
                  </div>
                </template>
                <template x-if="msg.mediaUrl && msg.mediaType !== 'image'">
                  <div class="mb-2 p-2 bg-gray-100 rounded flex items-center gap-2 border border-gray-200">
                    <div class="bg-gray-300 p-2 rounded text-gray-600 text-lg">
                      üìÑ
                    </div>
                    <div class="overflow-hidden">
                      <a :href="msg.mediaUrl" download
                        class="text-blue-600 font-bold hover:underline truncate block text-sm"
                        x-text="'Download File'"></a>
                      <span class="text-[10px] text-gray-500 uppercase" x-text="msg.mediaType || 'FILE'"></span>
                    </div>
                  </div>
                </template>
                <p x-text="msg.text" class="whitespace-pre-wrap"></p>
                <div class="text-[10px] text-right mt-1 opacity-60" x-text="formatTime(msg.timestamp || msg.time)">
                </div>
              </div>
              <button x-show="!msg.fromMe" @click="deleteMessage(msg.id)"
                class="opacity-0 group-hover:opacity-100 text-red-400 hover:text-red-600 text-xs self-center px-2 transition">
                üóëÔ∏è
              </button>
            </div>
          </template>
        </div>

        <div x-show="activeChat" class="glass p-4 border-t border-white/50 sticky bottom-0 z-20 !overflow-visible">
          <div x-show="selectedFile"
            class="mb-2 p-3 bg-white/80 backdrop-blur-sm rounded-xl border border-blue-200 flex justify-between items-center shadow-sm animate-fade-in">
            <div class="flex items-center gap-2 overflow-hidden">
              <span class="bg-blue-100 p-1.5 rounded text-lg">üìÑ</span>
              <span class="text-sm text-gray-700 truncate max-w-xs font-medium"
                x-text="selectedFile ? selectedFile.name : ''"></span>
            </div>
            <button @click="selectedFile = null" class="text-red-500 hover:bg-red-50 p-1.5 rounded-lg transition">
              ‚úï
            </button>
          </div>
          <div
            class="flex items-center gap-3 bg-white/80 backdrop-blur-md rounded-2xl px-4 py-3 border border-white/60 shadow-lg ring-1 ring-black/5 focus-within:ring-2 focus-within:ring-blue-500 transition-all duration-300 relative">
            <!-- Mobile Action Menu Support -->
            <div class="md:hidden relative" x-cloak>
              <button @click="mobileActionMenu = !mobileActionMenu"
                class="text-gray-400 hover:text-blue-600 transition-transform active:scale-95" type="button">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24"
                  stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
                </svg>
              </button>

              <!-- Popup Menu -->
              <div x-show="mobileActionMenu" @click.outside="mobileActionMenu = false"
                x-transition:enter="transition ease-out duration-200"
                x-transition:enter-start="opacity-0 scale-95 translate-y-2"
                x-transition:enter-end="opacity-100 scale-100 translate-y-0"
                class="absolute bottom-full left-0 mb-3 w-48 bg-white/95 backdrop-blur-xl rounded-2xl shadow-2xl border border-white/50 z-50 overflow-hidden ring-1 ring-black/5"
                style="display: none">
                <div class="flex flex-col py-2">
                  <button @click="$refs.fileInput.click(); mobileActionMenu = false"
                    class="text-left px-4 py-3 hover:bg-gray-50 flex items-center gap-3 text-gray-700 text-sm font-bold border-b border-gray-100 transition-colors">
                    <span class="bg-blue-100 text-blue-600 p-1.5 rounded-lg">üìé</span>
                    Attach File
                  </button>
                  <button @click="openInvoiceModal(); mobileActionMenu = false"
                    class="text-left px-4 py-3 hover:bg-gray-50 flex items-center gap-3 text-gray-700 text-sm font-bold border-b border-gray-100 transition-colors">
                    <span class="bg-indigo-100 text-indigo-600 p-1.5 rounded-lg">üìÑ</span>
                    Buat Invoice
                  </button>
                  <button @click="openScheduleModal(); mobileActionMenu = false"
                    class="text-left px-4 py-3 hover:bg-gray-50 flex items-center gap-3 text-gray-700 text-sm font-bold transition-colors">
                    <span class="bg-cyan-100 text-cyan-600 p-1.5 rounded-lg">üìÖ</span>
                    Buat Jadwal
                  </button>
                </div>
              </div>
            </div>

            <button @click="$refs.fileInput.click()"
              class="hidden md:block text-gray-400 hover:text-blue-600 transition-transform hover:scale-110 active:scale-95"
              title="Attach File">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24"
                stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                  d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13" />
              </svg>
            </button>
            <input type="file" x-ref="fileInput" @change="handleFileSelect"
              accept="image/*,video/*,.pdf,.doc,.docx,.xls,.xlsx,.csv,.txt" class="hidden" />

            <button @click="openInvoiceModal"
              class="hidden md:block text-gray-400 hover:text-indigo-600 transition-transform hover:scale-110 active:scale-95"
              title="Buat Invoice">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24"
                stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                  d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
              </svg>
            </button>
            <button @click="openScheduleModal()"
              class="hidden md:block text-gray-400 hover:text-cyan-600 transition-transform hover:scale-110 active:scale-95"
              title="Buat Jadwal">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24"
                stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                  d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
              </svg>
            </button>
            <textarea x-model="inputText" @keydown.enter.prevent="sendMessage" rows="1"
              class="flex-1 bg-transparent outline-none resize-none text-sm max-h-32 py-3 px-4 placeholder-gray-400 font-medium text-gray-700"
              placeholder="Ketik pesan anda..."></textarea>
            <button @click="sendMessage"
              class="bg-gradient-to-r from-indigo-600 to-purple-600 text-white p-2 rounded-xl shadow-lg shadow-indigo-200 hover:shadow-indigo-300 transform transition-all hover:-translate-y-1 active:translate-y-0 disabled:opacity-50"
              :disabled="!inputText.trim() && !selectedFile">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 rotate-90" viewBox="0 0 20 20" fill="currentColor">
                <path
                  d="M10.894 2.553a1 1 0 00-1.788 0l-7 14a1 1 0 001.169 1.409l5-1.429A1 1 0 009 15.571V11a1 1 0 112 0v4.571a1 1 0 00.725.962l5 1.428a1 1 0 001.17-1.408l-7-14z" />
              </svg>
            </button>
          </div>
        </div>
      </div>

      <div x-show="currentPage === 'analytics'" class="flex flex-col h-full w-full p-6 md:p-8 overflow-y-auto">
        <div class="flex flex-col md:flex-row md:justify-between md:items-end gap-4 mb-8 pt-10 md:pt-0">
          <div>
            <h1 class="text-3xl font-extrabold text-gray-800 tracking-tight">
              Dashboard Performa
            </h1>
            <p class="text-gray-500 text-sm mt-1 flex items-center gap-2">
              Data real-time untuk akun:
              <span x-text="sessionId" class="font-mono bg-blue-100 text-blue-700 px-2 py-0.5 rounded text-xs"></span>
            </p>
          </div>
          <div class="flex flex-wrap gap-2">
            <input type="month" x-model="selectedMonth" @change="fetchAnalytics"
              class="px-4 py-2 bg-white border border-gray-200 text-sm text-gray-600 rounded-lg hover:bg-gray-50 shadow-sm transition focus:ring-2 focus:ring-blue-500 outline-none" />
            <button @click="fetchAnalytics"
              class="px-4 py-2 bg-white/60 hover:bg-white border border-gray-200 text-sm font-semibold text-gray-600 rounded-lg shadow-sm transition flex items-center gap-2 backdrop-blur-sm">
              <span>üîÑ</span> Refresh
            </button>
            <button @click="exportDashboard"
              class="px-4 py-2 bg-gradient-to-r from-emerald-500 to-teal-500 text-white text-sm font-bold rounded-lg hover:shadow-lg hover:shadow-emerald-200 transition flex items-center gap-2 transform hover:-translate-y-0.5">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24"
                stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                  d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
              </svg>
              Export Excel
            </button>
          </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
          <!-- 1. Chat Customer Baru -->
          <div class="glass p-6 rounded-3xl hover-card relative overflow-hidden group">
            <div
              class="absolute right-0 top-0 w-32 h-32 bg-gradient-to-br from-indigo-400/20 to-transparent rounded-bl-full -mr-10 -mt-10 transition-transform group-hover:scale-110">
            </div>
            <div class="relative z-10">
              <div class="flex items-center justify-between mb-4">
                <p class="text-gray-500 text-xs font-bold uppercase tracking-wider">
                  Pesan Masuk
                </p>
                <div class="p-2 bg-indigo-50 rounded-lg text-indigo-600 shadow-sm border border-indigo-100">
                  <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                      d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z">
                    </path>
                  </svg>
                </div>
              </div>
              <p class="text-4xl font-extrabold text-gray-800" x-text="stats.newCustomers || 0">
                0
              </p>
              <div class="mt-2 text-xs text-indigo-600 font-medium flex items-center gap-1">
                <span>‚Üó</span> <span>Updated Live</span>
              </div>
            </div>
          </div>

          <!-- 2. Pesan Belum Terbaca (Ganti AI Replies) -->
          <div class="glass p-6 rounded-3xl hover-card relative overflow-hidden group">
            <div
              class="absolute right-0 top-0 w-32 h-32 bg-gradient-to-br from-pink-400/20 to-transparent rounded-bl-full -mr-10 -mt-10 transition-transform group-hover:scale-110">
            </div>
            <div class="relative z-10">
              <div class="flex items-center justify-between mb-4">
                <p class="text-gray-500 text-xs font-bold uppercase tracking-wider">
                  Belum Terbaca
                </p>
                <div class="p-2 bg-pink-50 rounded-lg text-pink-600 shadow-sm border border-pink-100">
                  <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" viewBox="0 0 24 24"
                    stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                      d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
                  </svg>
                </div>
              </div>
              <p class="text-4xl font-extrabold text-gray-800" x-text="totalUnread">
                0
              </p>
              <div class="mt-2 text-xs text-pink-500 font-medium flex items-center gap-1" x-show="totalUnread > 0">
                <span>‚ö†Ô∏è</span> <span>Action Needed</span>
              </div>
              <div class="mt-2 text-xs text-gray-400 font-medium flex items-center gap-1" x-show="totalUnread === 0">
                <span>‚úÖ</span> <span>All Caught Up</span>
              </div>
            </div>
          </div>

          <!-- 3. Terbit Invoice -->
          <div class="glass p-6 rounded-3xl hover-card relative overflow-hidden group">
            <div
              class="absolute right-0 top-0 w-32 h-32 bg-gradient-to-br from-purple-400/20 to-transparent rounded-bl-full -mr-10 -mt-10 transition-transform group-hover:scale-110">
            </div>
            <div class="relative z-10">
              <div class="flex items-center justify-between mb-4">
                <p class="text-gray-500 text-xs font-bold uppercase tracking-wider">
                  Terbit Invoice
                </p>
                <div class="p-2 bg-purple-50 rounded-lg text-purple-600 shadow-sm border border-purple-100">
                  <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" viewBox="0 0 24 24"
                    stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                      d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                  </svg>
                </div>
              </div>
              <p class="text-4xl font-extrabold text-gray-800" x-text="stats.invoiceIssued || 0">
                0
              </p>
              <div class="mt-2 text-xs text-purple-600 font-medium flex items-center gap-1">
                <span>üìä</span> <span>Check Unpaid</span>
              </div>
            </div>
          </div>

          <!-- 4. Lunas (Paid) -->
          <div class="glass p-6 rounded-3xl hover-card relative overflow-hidden group">
            <div
              class="absolute right-0 top-0 w-32 h-32 bg-gradient-to-br from-emerald-400/20 to-transparent rounded-bl-full -mr-10 -mt-10 transition-transform group-hover:scale-110">
            </div>
            <div class="relative z-10">
              <div class="flex items-center justify-between mb-4">
                <p class="text-gray-500 text-xs font-bold uppercase tracking-wider">
                  Lunas (Paid)
                </p>
                <div class="p-2 bg-emerald-50 rounded-lg text-emerald-600 shadow-sm border border-emerald-100">
                  <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" viewBox="0 0 24 24"
                    stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                      d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                  </svg>
                </div>
              </div>
              <p class="text-4xl font-extrabold text-emerald-600" x-text="stats.invoicePaid || 0">
                0
              </p>
              <div class="mt-2 text-xs text-emerald-600 font-medium flex items-center gap-1">
                <span>üí∞</span> <span>Great Job!</span>
              </div>
            </div>
          </div>
        </div>

        <!-- Row 2: Grafik Perbandingan & Jam Ramai Chat (50/50) -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
          <!-- Grafik Perbandingan Aktivitas -->
          <div class="glass p-6 rounded-2xl hover-card flex flex-col min-h-[280px] sm:min-h-[320px]">
            <div class="flex justify-between items-center mb-4">
              <h3 class="font-bold text-gray-800 text-sm sm:text-base">
                üìä Grafik Perbandingan Aktivitas
              </h3>
            </div>
            <div class="flex-1 relative w-full h-full min-h-[200px]">
              <canvas id="messageChart"></canvas>
            </div>
          </div>

          <!-- Jam Ramai Chat -->
          <div class="glass rounded-2xl hover-card flex flex-col overflow-hidden min-h-[280px] sm:min-h-[320px]">
            <div class="p-4 border-b border-gray-200/50 bg-gray-50/50">
              <h3 class="font-bold text-gray-800 text-sm sm:text-base">
                ‚è∞ Jam Ramai Chat
              </h3>
            </div>
            <div class="flex-1 p-3 relative min-h-[200px]">
              <canvas id="hourlyChart"></canvas>
            </div>
          </div>
        </div>

        <!-- Row 3: Top Produk & Top Customer (50/50) -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
          <!-- Top Products Section -->
          <div class="glass rounded-2xl hover-card flex flex-col overflow-hidden h-72">
            <div class="p-4 border-b border-gray-200/50 bg-gray-50/50 flex justify-between items-center">
              <h3 class="font-bold text-gray-800 text-sm">üèÜ Top Produk</h3>
              <span class="text-[10px] text-gray-500 bg-gray-200 px-2 py-0.5 rounded-full">Best Sellers</span>
            </div>
            <div class="flex-1 overflow-y-auto table-scroll bg-transparent p-2">
              <div class="flex flex-col gap-2">
                <template x-for="(prod, index) in topProducts" :key="prod.name">
                  <div
                    class="flex items-center gap-3 p-2 rounded-lg hover:bg-gray-50 transition border border-transparent hover:border-gray-100">
                    <!-- Rank Badge -->
                    <div
                      class="w-8 h-8 flex items-center justify-center rounded-full font-bold text-xs shadow-sm flex-shrink-0"
                      :class="{
                          'bg-yellow-100 text-yellow-700 border border-yellow-200': index === 0,
                          'bg-gray-100 text-gray-700 border border-gray-200': index === 1,
                          'bg-orange-100 text-orange-800 border border-orange-200': index === 2,
                          'bg-white text-gray-500 border border-gray-100': index > 2
                        }" x-text="index + 1"></div>

                    <!-- Product Info -->
                    <div class="flex-1 min-w-0">
                      <p class="text-sm font-medium text-gray-800 truncate" x-text="prod.name" :title="prod.name"></p>
                      <!-- Progress Bar -->
                      <div class="w-full bg-gray-100 rounded-full h-1.5 mt-1.5 overflow-hidden">
                        <div class="h-1.5 rounded-full transition-all duration-500" :class="{
                              'bg-yellow-400': index === 0,
                              'bg-gray-400': index === 1,
                              'bg-orange-400': index === 2,
                              'bg-blue-400': index > 2
                            }" :style="`width: ${(prod.totalQty / (topProducts[0]?.totalQty || 1)) * 100}%`"></div>
                      </div>
                    </div>

                    <!-- Qty -->
                    <div class="text-right">
                      <p class="text-sm font-bold text-gray-700" x-text="prod.totalQty"></p>
                      <p class="text-[10px] text-gray-400">Terjual</p>
                    </div>
                  </div>
                </template>

                <div x-show="topProducts.length === 0"
                  class="flex flex-col items-center justify-center h-32 text-gray-400">
                  <svg class="w-8 h-8 mb-2 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                      d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"></path>
                  </svg>
                  <p class="text-xs">Belum ada data penjualan</p>
                </div>
              </div>
            </div>
          </div>

          <!-- Top Customers Section -->
          <div class="glass rounded-2xl hover-card flex flex-col overflow-hidden h-72">
            <div class="p-4 border-b border-gray-200/50 bg-gray-50/50 flex justify-between items-center">
              <h3 class="font-bold text-gray-800 text-sm">üëë Top Customer</h3>
              <span class="text-[10px] text-gray-500 bg-gray-200 px-2 py-0.5 rounded-full">Most Active</span>
            </div>
            <div class="flex-1 overflow-y-auto table-scroll bg-transparent p-2">
              <div class="flex flex-col gap-2">
                <template x-for="(cust, index) in topCustomers" :key="cust.customerJid">
                  <div
                    class="flex items-center gap-3 p-2 rounded-lg hover:bg-gray-50 transition border border-transparent hover:border-gray-100">
                    <!-- Rank Badge -->
                    <div
                      class="w-8 h-8 flex items-center justify-center rounded-full font-bold text-xs shadow-sm flex-shrink-0"
                      :class="{
                          'bg-purple-100 text-purple-700 border border-purple-200': index === 0,
                          'bg-gray-100 text-gray-700 border border-gray-200': index === 1,
                          'bg-pink-100 text-pink-800 border border-pink-200': index === 2,
                          'bg-white text-gray-500 border border-gray-100': index > 2
                        }" x-text="index + 1"></div>

                    <!-- Customer Info -->
                    <div class="flex-1 min-w-0">
                      <p class="text-sm font-medium text-gray-800 truncate" x-text="cust.customerName"
                        :title="cust.customerName"></p>
                      <p class="text-[10px] text-gray-400 truncate" x-text="cust.customerJid"></p>
                    </div>

                    <!-- Qty -->
                    <div class="text-right">
                      <p class="text-sm font-bold text-gray-700" x-text="cust.totalQty"></p>
                      <p class="text-[10px] text-gray-400">Items</p>
                    </div>
                  </div>
                </template>

                <div x-show="topCustomers.length === 0"
                  class="flex flex-col items-center justify-center h-32 text-gray-400">
                  <p class="text-xs">Belum ada data customer</p>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Row 4: Distribusi Label & Top Questions (50/50) -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
          <!-- Distribusi Label -->
          <div class="glass rounded-2xl hover-card flex flex-col overflow-hidden h-64">
            <div class="p-4 border-b border-gray-200/50 bg-gray-50/50">
              <h3 class="font-bold text-gray-800 text-sm">
                üè∑Ô∏è Distribusi Label
              </h3>
            </div>
            <div class="flex-1 overflow-y-auto table-scroll bg-transparent p-2">
              <div class="flex flex-col gap-2">
                <template x-for="label in labelDistribution" :key="label.name">
                  <div class="flex items-center justify-between p-2 hover:bg-gray-50 rounded">
                    <div class="flex items-center gap-2">
                      <span class="text-xs px-2 py-0.5 rounded font-bold" :class="getLabelColor(label.name)"
                        x-text="label.displayName"></span>
                    </div>
                    <span class="font-bold text-gray-700 text-sm" x-text="label.count"></span>
                  </div>
                </template>
                <div x-show="labelDistribution.length === 0" class="text-center text-gray-400 text-xs py-4">
                  Belum ada data label
                </div>
              </div>
            </div>
          </div>

          <!-- Top Questions -->
          <div class="glass rounded-2xl hover-card flex flex-col overflow-hidden h-64">
            <div class="p-4 border-b border-gray-200/50 bg-gray-50/50">
              <h3 class="font-bold text-gray-800 text-sm">
                ‚ùì Pertanyaan Sering Diajukan
              </h3>
            </div>
            <div class="flex-1 overflow-y-auto table-scroll bg-transparent p-2">
              <div class="flex flex-col gap-2">
                <template x-for="(q, index) in topQuestions" :key="index">
                  <div
                    class="flex items-center gap-3 p-2 rounded-lg hover:bg-gray-50 transition border border-transparent hover:border-gray-100">
                    <div
                      class="w-6 h-6 flex items-center justify-center rounded-full bg-blue-100 text-blue-600 font-bold text-xs"
                      x-text="index + 1"></div>
                    <div class="flex-1 min-w-0">
                      <p class="text-sm text-gray-800 truncate" x-text="q.question" :title="q.question"></p>
                    </div>
                    <div class="text-xs font-bold text-gray-500" x-text="q.count + 'x'"></div>
                  </div>
                </template>
                <div x-show="!topQuestions || topQuestions.length === 0" class="text-center text-gray-400 text-xs py-4">
                  Belum ada data
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Row 5: Top Complaints (New) -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mt-6">
          <div class="glass rounded-2xl hover-card flex flex-col overflow-hidden h-64">
            <div class="p-4 border-b border-gray-200/50 bg-red-50/50">
              <h3 class="font-bold text-red-800 text-sm">
                ‚ö†Ô∏è Keluhan Paling Sering
              </h3>
            </div>
            <div class="flex-1 overflow-y-auto table-scroll bg-transparent p-2">
              <div class="flex flex-col gap-2">
                <template x-for="(count, keyword) in topComplaints" :key="keyword">
                  <div
                    class="flex items-center justify-between p-2 hover:bg-red-50 rounded transition border border-transparent hover:border-red-100">
                    <div class="flex items-center gap-2">
                      <span class="text-xs font-bold capitalize text-red-700 bg-red-100 px-2 py-0.5 rounded"
                        x-text="keyword"></span>
                    </div>
                    <span class="font-bold text-red-800 text-sm" x-text="count + 'x'"></span>
                  </div>
                </template>
                <div x-show="!topComplaints || Object.keys(topComplaints).length === 0"
                  class="text-center text-gray-400 text-xs py-4">
                  Belum ada keluhan terdeteksi
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Advance Setting Page -->
      <div x-show="currentPage === 'settings'" class="flex-1 p-8 overflow-y-auto">
        <h1 class="text-2xl font-bold text-gray-800 mb-6">
          Advance Settings
        </h1>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
          <!-- 1. AI Persona Settings -->
          <div class="space-y-6">
            <div class="glass p-6 rounded-2xl hover-card border border-white/20 min-w-0">
              <div class="flex justify-between items-center mb-4">
                <h2 class="text-lg font-bold text-gray-800">ü§ñ AI Persona</h2>
                <button @click="savePrompt"
                  class="bg-blue-600 text-white px-4 py-2 rounded-lg text-sm font-bold hover:bg-blue-700 transition">
                  Simpan Prompt
                </button>
              </div>
              <p class="text-sm text-gray-500 mb-2">
                Instruksi utama untuk mengatur gaya bicara dan perilaku bot.
              </p>
              <textarea x-model="aiPrompt"
                class="w-full h-64 p-4 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 outline-none resize-y font-mono bg-gray-50"
                placeholder="Tulis instruksi system prompt di sini..."></textarea>
            </div>
          </div>

          <!-- 2. Knowledge Base & Inventory -->
          <div class="space-y-6">
            <!-- Inventory Master -->
            <div class="glass p-6 rounded-2xl hover-card border border-white/20">
              <div class="flex justify-between items-start mb-4">
                <div>
                  <h2 class="text-lg font-bold text-gray-800">
                    üì¶ Inventory Master
                  </h2>
                  <p class="text-sm text-gray-500">
                    Pilih sumber data utama untuk stok & harga produk.
                  </p>
                </div>
                <!-- Source Selector -->
                <div class="flex bg-gray-100 p-1 rounded-lg">
                  <button @click="setInventorySource('excel')"
                    :class="inventorySource === 'excel' ? 'bg-white shadow text-green-700' : 'text-gray-500 hover:text-gray-700'"
                    class="px-3 py-1.5 rounded-md text-xs font-bold transition flex items-center gap-2">
                    <span>üìä</span> Excel File
                  </button>
                  <button @click="setInventorySource('sheet')"
                    :class="inventorySource === 'sheet' ? 'bg-white shadow text-blue-700' : 'text-gray-500 hover:text-gray-700'"
                    class="px-3 py-1.5 rounded-md text-xs font-bold transition flex items-center gap-2">
                    <span>üåê</span> Google Sheet
                  </button>
                </div>
              </div>

              <!-- EXCEL SECTION -->
              <div x-show="inventorySource === 'excel'" x-transition>
                <div class="flex items-center gap-4">
                  <div class="flex-1 p-3 bg-gray-50 border border-gray-200 rounded-lg flex items-center gap-3">
                    <span class="text-2xl">üìä</span>
                    <div class="overflow-hidden">
                      <p class="text-xs font-bold text-gray-500 uppercase">
                        Current File
                      </p>
                      <p class="text-sm font-medium text-gray-800 truncate" x-text="inventoryFile || 'Belum ada file'">
                      </p>
                    </div>
                  </div>
                  <button @click="$refs.invInput.click()"
                    class="bg-green-600 text-white px-4 py-3 rounded-lg text-sm font-bold hover:bg-green-700 transition whitespace-nowrap">
                    Upload Master
                  </button>
                  <input type="file" x-ref="invInput" @change="uploadInventory" accept=".xlsx, .xls" class="hidden" />
                </div>
              </div>

              <!-- GOOGLE SHEET SECTION -->
              <div x-show="inventorySource === 'sheet'" x-transition>
                <div class="bg-blue-50 p-4 rounded-lg border border-blue-100">
                  <label class="block text-xs font-bold text-blue-800 mb-2 uppercase">Google Sheet Public CSV
                    URL</label>
                  <div class="space-y-2">
                    <input type="text" x-model="inventoryUrl"
                      placeholder="https://docs.google.com/spreadsheets/d/.../export?format=csv"
                      class="w-full p-2.5 border border-blue-200 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500" />
                    <div class="flex gap-2">
                      <button @click="saveInventoryUrl"
                        class="flex-1 bg-blue-600 text-white px-4 py-2 rounded-lg text-sm font-bold hover:bg-blue-700 transition">
                        üíæ Simpan
                      </button>
                      <button @click="syncInventory"
                        class="flex-1 bg-orange-500 text-white px-4 py-2 rounded-lg text-sm font-bold hover:bg-orange-600 transition flex items-center justify-center gap-2">
                        <span>üîÑ</span> Sync
                      </button>
                    </div>
                  </div>
                  <p class="text-xs text-blue-600 mt-2">
                    ‚ÑπÔ∏è Caranya: Masukan Link data spreadsheet anda kesini >
                    kemudian Save & Sync
                  </p>
                </div>
              </div>
            </div>

            <!-- Knowledge Base -->
            <div class="glass p-6 rounded-2xl hover-card border border-white/20">
              <div class="flex justify-between items-center mb-4">
                <div>
                  <h2 class="text-lg font-bold text-gray-800">
                    üìö Knowledge Base
                  </h2>
                  <p class="text-sm text-gray-500">
                    File tambahan untuk melatih bot (SOP, FAQ, Info Toko).
                  </p>
                </div>
                <button @click="$refs.kbInput.click()"
                  class="bg-purple-600 text-white px-4 py-2 rounded-lg text-sm font-bold hover:bg-purple-700 transition">
                  + Tambah File
                </button>
                <input type="file" x-ref="kbInput" @change="uploadKnowledge" accept=".xlsx, .xls" class="hidden" />
              </div>

              <div class="space-y-2">
                <template x-for="file in knowledgeFiles" :key="file">
                  <div class="flex items-center justify-between p-3 bg-gray-50 border border-gray-200 rounded-lg group">
                    <div class="flex items-center gap-3 overflow-hidden">
                      <span class="text-xl">üìÑ</span>
                      <span class="text-sm font-medium text-gray-700 truncate" x-text="file"></span>
                    </div>
                    <button @click="deleteKnowledge(file)"
                      class="text-gray-400 hover:text-red-500 p-1 opacity-0 group-hover:opacity-100 transition">
                      <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24"
                        stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                          d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                      </svg>
                    </button>
                  </div>
                </template>
                <div x-show="knowledgeFiles.length === 0"
                  class="text-center py-8 text-gray-400 border-2 border-dashed border-gray-200 rounded-lg">
                  Belum ada file knowledge base
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Row 2: Template Pesan & Custom Invoice (50/50) -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mt-6">
          <!-- Template Pesan -->
          <div class="glass p-6 rounded-2xl hover-card border border-white/20">
            <div class="flex justify-between items-center mb-4">
              <h2 class="text-lg font-bold text-gray-800">
                ‚ö° Template Pesan
              </h2>
              <button @click="saveTemplates"
                class="bg-blue-600 text-white px-4 py-2 rounded-lg text-sm font-bold hover:bg-blue-700 transition">
                Simpan Template
              </button>
            </div>
            <p class="text-sm text-gray-500 mb-4">
              Shortcut untuk balasan cepat. Ketik shortcut di chat (misal:
              /rek) untuk memunculkan pesan.
            </p>
            <div class="space-y-2 mb-4 max-h-80 overflow-y-auto">
              <template x-for="(tpl, idx) in messageTemplates" :key="idx">
                <div class="flex gap-2 items-start">
                  <input type="text" x-model="tpl.shortcut" placeholder="/shortcut"
                    class="w-1/3 border border-gray-300 rounded p-2 text-sm font-mono" />
                  <textarea x-model="tpl.content" placeholder="Isi pesan..."
                    class="flex-1 border border-gray-300 rounded p-2 text-sm resize-y" rows="2"></textarea>
                  <button @click="removeTemplate(idx)" class="text-red-500 hover:text-red-700 p-2">
                    ‚úï
                  </button>
                </div>
              </template>
            </div>
            <button @click="addTemplate"
              class="w-full py-2 border border-dashed border-gray-300 text-gray-500 rounded-lg hover:bg-gray-50 text-sm">
              + Tambah Template
            </button>
          </div>

          <!-- Custom Invoice -->
          <div class="glass p-6 rounded-2xl hover-card border border-white/20">
            <h2 class="text-lg font-bold text-gray-800 mb-4">
              üßæ Custom Invoice
            </h2>
            <div class="space-y-4 max-h-96 overflow-y-auto pr-2">
              <div>
                <label class="block text-xs font-bold text-gray-700 mb-1 uppercase">Nama Toko / Judul Invoice</label>
                <input type="text" x-model="invoiceTitle"
                  class="w-full p-3 border border-gray-200 rounded-lg text-sm focus:ring-2 focus:ring-green-500 focus:border-green-500"
                  placeholder="CONTOH: TOKO MAJU JAYA" />
              </div>
              <div>
                <label class="block text-xs font-bold text-gray-700 mb-1 uppercase">Alamat & Kontak</label>
                <textarea x-model="invoiceAddress" rows="3"
                  class="w-full p-3 border border-gray-200 rounded-lg text-sm focus:ring-2 focus:ring-green-500 focus:border-green-500"
                  placeholder="Jl. Contoh No. 123, Jakarta&#10;Telp: 0812-3456-7890"></textarea>
              </div>

              <div class="grid grid-cols-2 gap-4">
                <!-- Logo -->
                <div>
                  <label class="block text-xs font-bold text-gray-700 mb-1 uppercase">Logo Toko</label>
                  <div class="flex items-center gap-3">
                    <div
                      class="w-12 h-12 bg-gray-100 rounded-lg border border-gray-200 flex items-center justify-center overflow-hidden">
                      <template x-if="invoiceLogoPreview">
                        <img :src="invoiceLogoPreview" class="w-full h-full object-cover" />
                      </template>
                      <template x-if="!invoiceLogoPreview && invoiceLogo">
                        <img :src="'/uploads/' + invoiceLogo" class="w-full h-full object-cover" />
                      </template>
                      <template x-if="!invoiceLogoPreview && !invoiceLogo">
                        <span class="text-lg text-gray-300">üñºÔ∏è</span>
                      </template>
                    </div>
                    <div>
                      <input type="file" x-ref="logoInput" @change="handleLogoUpload" accept="image/*" class="hidden" />
                      <button @click="$refs.logoInput.click()" class="text-xs text-blue-600 font-bold hover:underline">
                        Upload Logo
                      </button>
                    </div>
                  </div>
                </div>

                <!-- Footer -->
                <div>
                  <label class="block text-xs font-bold text-gray-700 mb-1 uppercase">Footer Note</label>
                  <textarea x-model="invoiceFooter" rows="2"
                    class="w-full p-2 border border-gray-200 rounded-lg text-sm focus:ring-2 focus:ring-green-500 focus:border-green-500"
                    placeholder="Terima kasih!"></textarea>
                </div>
              </div>

              <!-- Shipping Options -->
              <div>
                <label class="block text-xs font-bold text-gray-700 mb-1 uppercase">Opsi Ongkir</label>
                <div class="space-y-2 mb-2">
                  <template x-for="(opt, idx) in shippingOptions" :key="idx">
                    <div class="flex gap-2">
                      <input type="text" x-model="opt.label" class="flex-1 p-2 border border-gray-200 rounded text-sm"
                        placeholder="JNE, GoSend" />
                      <input type="number" x-model="opt.price" class="w-20 p-2 border border-gray-200 rounded text-sm"
                        placeholder="Harga" />
                      <button @click="removeShippingOption(idx)" class="text-red-500 hover:text-red-700 px-2">
                        ‚úï
                      </button>
                    </div>
                  </template>
                </div>
                <button @click="addShippingOption" class="text-xs text-blue-600 font-bold hover:underline">
                  + Tambah Opsi Ongkir
                </button>
              </div>
            </div>
            <div class="mt-4 flex justify-end">
              <button @click="saveInvoiceSettings"
                class="bg-green-600 text-white px-4 py-2 rounded-lg text-sm font-bold hover:bg-green-700 transition shadow-md">
                Simpan Invoice
              </button>
            </div>
          </div>
        </div>

        <!-- Auto Reply (New Section) -->
        <div class="mt-6">
          <div class="glass p-6 rounded-2xl hover-card border border-white/20">
            <h2 class="text-lg font-bold text-gray-800 mb-4">
              ü§ñ Quick Reply / Auto Reply
            </h2>
            <p class="text-sm text-gray-500 mb-4">
              Bot akan membalas otomatis jika pesan customer sama persis dengan keyword (Contoh: "norek").
            </p>

            <div class="flex gap-4 mb-6">
              <div class="w-1/3">
                <input type="text" x-model="newAutoReply.keyword" placeholder="Keyword (Misal: norek min)"
                  class="w-full p-3 border border-gray-200 rounded-lg text-sm focus:ring-2 focus:ring-blue-500">
              </div>
              <div class="flex-1">
                <input type="text" x-model="newAutoReply.response" placeholder="Balasan Otomatis"
                  class="w-full p-3 border border-gray-200 rounded-lg text-sm focus:ring-2 focus:ring-blue-500">
              </div>
              <button @click="addAutoReply"
                class="bg-blue-600 text-white px-6 py-2 rounded-lg font-bold hover:bg-blue-700 transition">
                Tambah
              </button>
            </div>

            <div class="overflow-x-auto">
              <table class="w-full text-sm text-left">
                <thead class="bg-gray-50 text-gray-600 font-bold border-b border-gray-200">
                  <tr>
                    <th class="px-4 py-3">Keyword</th>
                    <th class="px-4 py-3">Response</th>
                    <th class="px-4 py-3 text-right">Aksi</th>
                  </tr>
                </thead>
                <tbody class="divide-y divide-gray-100">
                  <template x-for="reply in autoReplies" :key="reply.id">
                    <tr class="hover:bg-gray-50 transition">
                      <td class="px-4 py-3 font-medium text-blue-600" x-text="reply.keyword"></td>
                      <td class="px-4 py-3 truncate max-w-xs" x-text="reply.response"></td>
                      <td class="px-4 py-3 text-right">
                        <button @click="deleteAutoReply(reply.id)"
                          class="text-red-500 hover:text-red-700 font-bold text-xs">Hapus</button>
                      </td>
                    </tr>
                  </template>
                  <tr x-show="autoReplies.length === 0">
                    <td colspan="3" class="px-4 py-3 text-center text-gray-400 italic">Belum ada auto reply</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
      <!-- Live Schedule & Broadcast -->
      <div x-show="currentPage === 'schedule'" class="flex-1 p-8 overflow-y-auto">
        <div class="flex justify-between items-center mb-6">
          <div>
            <h1 class="text-2xl font-bold text-gray-800">
              Live Schedule & Broadcast
            </h1>
            <p class="text-sm text-gray-500">
              Kelola jadwal manual dan broadcast otomatis
            </p>
          </div>
          <div class="flex gap-2">
            <button @click="openScheduleModal()"
              class="bg-blue-600 text-white px-4 py-2 rounded-lg font-bold hover:bg-blue-700 transition flex items-center gap-2">
              <span>üìÖ</span> Buat Jadwal
            </button>
            <button @click="openBroadcastScheduleModal()"
              class="bg-gradient-to-r from-orange-500 to-pink-500 text-white px-4 py-2 rounded-lg font-bold hover:shadow-lg transition flex items-center gap-2">
              <span>üì¢</span> Buat Broadcast
            </button>
          </div>
        </div>

        <!-- Calendar Component -->
        <div class="glass rounded-2xl hover-card p-6 mb-6">
          <div class="flex justify-between items-center mb-4">
            <h2 class="text-lg font-bold text-gray-800" x-text="`${monthNames[calendarMonth]} ${calendarYear}`"></h2>
            <div class="flex gap-2">
              <button @click="changeMonth(-1)" class="p-2 hover:bg-gray-100 rounded-lg text-gray-600">
                ‚óÄ
              </button>
              <button @click="changeMonth(1)" class="p-2 hover:bg-gray-100 rounded-lg text-gray-600">
                ‚ñ∂
              </button>
            </div>
          </div>

          <div class="grid grid-cols-7 gap-2 text-center mb-2">
            <template x-for="day in ['Min', 'Sen', 'Sel', 'Rab', 'Kam', 'Jum', 'Sab']">
              <div class="text-xs font-bold text-gray-400 uppercase py-2" x-text="day"></div>
            </template>
          </div>

          <div class="grid grid-cols-7 gap-2">
            <template x-for="(day, index) in calendarDays" :key="index">
              <div @click="selectDate(day)"
                class="h-14 rounded-lg border border-transparent flex flex-col items-center justify-center relative transition cursor-pointer"
                :class="{
                       'bg-blue-600 text-white shadow-md': selectedDate === day.fullDate,
                       'bg-blue-50 text-blue-700 font-bold border-blue-200': isToday(day) && selectedDate !== day.fullDate,
                       'hover:bg-gray-100 text-gray-700': !isToday(day) && selectedDate !== day.fullDate && day.date,
                       'invisible': !day.date
                     }">
                <span x-text="day.date"></span>
                <!-- Indicators -->
                <div class="flex gap-1 mt-1">
                  <div x-show="day.hasSchedule" class="w-1.5 h-1.5 rounded-full"
                    :class="selectedDate === day.fullDate ? 'bg-white' : 'bg-orange-500'" title="Ada Jadwal Manual">
                  </div>
                  <div x-show="day.hasBroadcast" class="w-1.5 h-1.5 rounded-full"
                    :class="selectedDate === day.fullDate ? 'bg-white' : 'bg-pink-500'" title="Ada Broadcast"></div>
                </div>
              </div>
            </template>
          </div>
        </div>

        <div class="flex justify-between items-center mb-4" x-show="selectedDate">
          <h3 class="font-bold text-gray-700">
            Jadwal Tanggal:
            <span x-text="formatDateTime(selectedDate).split(',')[1]"></span>
          </h3>
          <button @click="selectedDate = null" class="text-sm text-blue-600 hover:underline">
            Tampilkan Semua
          </button>
        </div>

        <div class="glass rounded-2xl hover-card overflow-hidden">
          <div class="overflow-x-auto">
            <table class="w-full text-sm text-left">
              <thead class="bg-gray-50 text-gray-600 font-bold border-b border-gray-200">
                <tr>
                  <th class="px-6 py-4">Waktu</th>
                  <th class="px-6 py-4">Jenis</th>
                  <th class="px-6 py-4">Judul & Deskripsi</th>
                  <th class="px-6 py-4">Target/Customer</th>
                  <th class="px-6 py-4 text-right">Aksi</th>
                </tr>
              </thead>
              <tbody class="divide-y divide-gray-100">
                <!-- SECTION: ONGOING / AKAN DATANG -->
                <tr class="bg-blue-50/50">
                  <td colspan="5" class="px-6 py-2 text-xs font-bold text-blue-800 uppercase tracking-wider">
                    ‚è≥ Ongoing / Akan Datang
                  </td>
                </tr>

                <!-- Regular Schedules (Always Active) -->
                <template x-for="sch in filteredSchedules" :key="'sch-'+sch.id">
                  <tr class="hover:bg-gray-50 transition">
                    <td class="px-6 py-4 whitespace-nowrap">
                      <div class="font-bold text-gray-800" x-text="formatDateTime(sch.date).split(',')[1] || ''"></div>
                    </td>
                    <td class="px-6 py-4">
                      <span class="px-2 py-1 rounded text-xs font-bold bg-orange-100 text-orange-700">Schedule</span>
                    </td>
                    <td class="px-6 py-4">
                      <div class="font-bold text-gray-800" x-text="sch.title"></div>
                      <div class="text-xs text-gray-500 truncate max-w-xs" x-text="sch.description"></div>
                    </td>
                    <td class="px-6 py-4">
                      <div class="text-gray-800 font-medium" x-text="formatCustomerDisplay(sch.customerJid)"></div>
                    </td>
                    <td class="px-6 py-4 text-right">
                      <button @click="openScheduleModal(sch)" class="text-blue-600 hover:text-blue-800 font-bold mr-3">
                        Edit
                      </button>
                      <button @click="deleteSchedule(sch.id)" class="text-red-600 hover:text-red-800 font-bold">
                        Hapus
                      </button>
                    </td>
                  </tr>
                </template>

                <!-- Active Broadcasts (PENDING) -->
                <template x-for="bc in filteredBroadcasts.filter(b => b.status === 'PENDING')"
                  :key="'bc-active-'+bc.id">
                  <tr class="hover:bg-gray-50 transition bg-pink-50/30">
                    <td class="px-6 py-4 whitespace-nowrap">
                      <div class="font-bold text-gray-800" x-text="formatDateTime(bc.scheduledAt).split(',')[1] || ''">
                      </div>
                    </td>
                    <td class="px-6 py-4">
                      <span class="px-2 py-1 rounded text-xs font-bold border"
                        :class="getBroadcastStatusColor(bc.status)">
                        Broadcast
                      </span>
                    </td>
                    <td class="px-6 py-4">
                      <div class="font-bold text-gray-800" x-text="bc.title"></div>
                      <div class="text-xs text-gray-500 truncate max-w-xs" x-text="bc.message"></div>
                    </td>
                    <td class="px-6 py-4">
                      <div class="text-gray-800 font-medium" x-text="getTargetLabelDisplay(bc.targetLabel)"></div>
                    </td>
                    <td class="px-6 py-4 text-right">
                      <button @click="openBroadcastScheduleModal(bc)"
                        class="text-blue-600 hover:text-blue-800 font-bold mr-3">
                        Edit
                      </button>
                      <button @click="cancelBroadcast(bc.id)" class="text-red-600 hover:text-red-800 font-bold">
                        Batal
                      </button>
                    </td>
                  </tr>
                </template>

                <!-- Empty State for Active -->
                <tr
                  x-show="filteredSchedules.length === 0 && filteredBroadcasts.filter(b => b.status === 'PENDING').length === 0">
                  <td colspan="5" class="px-6 py-4 text-center text-gray-400 italic text-sm">
                    Tidak ada jadwal aktif
                  </td>
                </tr>

                <!-- SECTION: HISTORY / RIWAYAT -->
                <tr class="bg-gray-100/80 border-t-4 border-gray-100">
                  <td colspan="5" class="px-6 py-2 text-xs font-bold text-gray-500 uppercase tracking-wider">
                    üìã Riwayat / Selesai
                  </td>
                </tr>

                <!-- History Broadcasts (Non-PENDING) -->
                <template x-for="bc in filteredBroadcasts.filter(b => b.status !== 'PENDING')"
                  :key="'bc-history-'+bc.id">
                  <tr class="hover:bg-gray-50 transition opacity-75 bg-gray-50">
                    <td class="px-6 py-4 whitespace-nowrap">
                      <div class="font-bold text-gray-600" x-text="formatDateTime(bc.scheduledAt).split(',')[1] || ''">
                      </div>
                    </td>
                    <td class="px-6 py-4">
                      <span class="px-2 py-1 rounded text-xs font-bold border"
                        :class="getBroadcastStatusColor(bc.status)">
                        Broadcast
                      </span>
                    </td>
                    <td class="px-6 py-4">
                      <div class="font-bold text-gray-600 line-through decoration-gray-400" x-text="bc.title"></div>
                      <div class="text-xs text-gray-500 truncate max-w-xs" x-text="bc.message"></div>
                    </td>
                    <td class="px-6 py-4">
                      <div class="text-gray-600 font-medium" x-text="getTargetLabelDisplay(bc.targetLabel)"></div>
                      <div x-show="bc.sentCount" class="text-xs text-gray-400">
                        Sent: <span x-text="bc.sentCount"></span>
                      </div>
                    </td>
                    <td class="px-6 py-4 text-right">
                      <button @click="deleteBroadcast(bc.id)"
                        class="text-gray-400 hover:text-red-600 font-bold text-xs">
                        Hapus Permanen
                      </button>
                    </td>
                  </tr>
                </template>

                <!-- Empty State for History -->
                <tr x-show="filteredBroadcasts.filter(b => b.status !== 'PENDING').length === 0">
                  <td colspan="5" class="px-6 py-4 text-center text-gray-400 italic text-sm">
                    Tidak ada riwayat
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
    </main>
  </div>

  <!-- ==================== REDESIGNED INVOICE MODAL ==================== -->
  <div x-show="showInvoiceModal" x-transition:enter="transition ease-out duration-300" 
    x-transition:enter-start="opacity-0" x-transition:enter-end="opacity-100"
    x-transition:leave="transition ease-in duration-200" x-transition:leave-start="opacity-100" 
    x-transition:leave-end="opacity-0"
    class="fixed inset-0 z-[60] bg-black/60 backdrop-blur-sm flex items-center justify-center p-2 sm:p-4" x-cloak>
    
    <div x-transition:enter="transition ease-out duration-300" 
      x-transition:enter-start="opacity-0 scale-95 translate-y-4" 
      x-transition:enter-end="opacity-100 scale-100 translate-y-0"
      class="bg-white rounded-2xl sm:rounded-3xl w-full max-w-2xl shadow-2xl relative flex flex-col max-h-[95vh] sm:max-h-[90vh] border border-gray-100">
      
      <!-- Premium Header with Gradient - Fixed, no shrink -->
      <div class="flex-shrink-0 bg-gradient-to-r from-indigo-600 via-purple-600 to-pink-500 px-4 sm:px-6 py-4 sm:py-5 relative overflow-hidden rounded-t-2xl sm:rounded-t-3xl">
        <!-- Decorative Elements -->
        <div class="absolute top-0 right-0 w-32 h-32 bg-white/10 rounded-full -translate-y-1/2 translate-x-1/2"></div>
        <div class="absolute bottom-0 left-0 w-24 h-24 bg-white/5 rounded-full translate-y-1/2 -translate-x-1/2"></div>
        
        <div class="relative flex justify-between items-start">
          <div class="flex items-center gap-3">
            <div class="w-10 h-10 sm:w-12 sm:h-12 bg-white/20 rounded-xl sm:rounded-2xl flex items-center justify-center backdrop-blur-sm">
              <span class="text-xl sm:text-2xl">üìÑ</span>
            </div>
            <div>
              <h2 class="text-lg sm:text-xl font-bold text-white tracking-tight">Invoice Manager</h2>
              <p class="text-white/70 text-[10px] sm:text-xs mt-0.5">Buat dan kelola invoice dengan mudah</p>
            </div>
          </div>
          <button @click="showInvoiceModal = false" 
            class="w-8 h-8 sm:w-9 sm:h-9 bg-white/20 hover:bg-white/30 rounded-full flex items-center justify-center transition-all text-white/80 hover:text-white backdrop-blur-sm hover:rotate-90 duration-300">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 sm:h-5 sm:w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
            </svg>
          </button>
        </div>
      </div>

      <!-- Modern Tabs - Fixed, no shrink -->
      <div class="flex-shrink-0 px-4 sm:px-6 pt-4 sm:pt-5 pb-2 bg-gradient-to-b from-gray-50 to-white">
        <div class="flex gap-2 p-1 bg-gray-100 rounded-xl">
          <button @click="invoiceTab = 'new'" 
            :class="invoiceTab === 'new' ? 'bg-white text-indigo-600 shadow-md' : 'text-gray-500 hover:text-gray-700'"
            class="flex-1 px-3 sm:px-4 py-2 sm:py-2.5 rounded-lg text-xs sm:text-sm font-bold transition-all duration-300 flex items-center justify-center gap-1.5 sm:gap-2">
            <span class="text-sm sm:text-base">‚ú®</span>
            <span>Buat Baru</span>
          </button>
          <button @click="invoiceTab = 'unpaid'; fetchUnpaidInvoices()"
            :class="invoiceTab === 'unpaid' ? 'bg-white text-orange-600 shadow-md' : 'text-gray-500 hover:text-gray-700'"
            class="flex-1 px-3 sm:px-4 py-2 sm:py-2.5 rounded-lg text-xs sm:text-sm font-bold transition-all duration-300 flex items-center justify-center gap-1.5 sm:gap-2">
            <span class="text-sm sm:text-base">‚è≥</span>
            <span>Belum Lunas</span>
            <span x-show="unpaidInvoices.length > 0" 
              class="bg-orange-500 text-white text-[10px] px-1.5 py-0.5 rounded-full font-bold min-w-[18px] text-center"
              x-text="unpaidInvoices.length"></span>
          </button>
        </div>
      </div>

      <!-- Tab: New Invoice -->
      <div x-show="invoiceTab === 'new'" class="flex-1 overflow-y-auto px-4 sm:px-6 py-3 sm:py-4 flex flex-col">
        
        <!-- Product Selector Card -->
        <div class="bg-gradient-to-br from-indigo-50 via-purple-50 to-pink-50 rounded-xl sm:rounded-2xl p-3 sm:p-4 mb-3 sm:mb-4 border border-indigo-100/50">
          <label class="block text-[10px] sm:text-xs font-bold text-indigo-700 mb-2 uppercase tracking-wider flex items-center gap-1.5">
            <span>üõçÔ∏è</span> Pilih Produk
          </label>
          <div class="flex gap-2">
            <div class="flex-1 relative">
              <select x-model="selectedProductIndex"
                class="w-full bg-white border-2 border-indigo-200 rounded-lg sm:rounded-xl p-2.5 sm:p-3 text-xs sm:text-sm outline-none focus:border-indigo-500 focus:ring-4 focus:ring-indigo-500/20 transition-all appearance-none cursor-pointer font-medium text-gray-700">
                <option value="">-- Pilih Produk --</option>
                <template x-for="(prod, index) in products" :key="index">
                  <option :value="index" x-text="getDisplayName(prod)"></option>
                </template>
              </select>
              <div class="absolute right-3 top-1/2 -translate-y-1/2 pointer-events-none text-indigo-400">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 sm:h-5 sm:w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                </svg>
              </div>
            </div>
            <input type="number" x-model="qtyInput" min="1" value="1"
              class="w-14 sm:w-16 bg-white border-2 border-indigo-200 rounded-lg sm:rounded-xl p-2.5 sm:p-3 text-xs sm:text-sm text-center font-bold focus:border-indigo-500 focus:ring-4 focus:ring-indigo-500/20 transition-all" placeholder="Qty" />
            <button @click="addToCart"
              class="bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-700 hover:to-purple-700 text-white px-4 sm:px-5 py-2.5 sm:py-3 rounded-lg sm:rounded-xl text-xs sm:text-sm font-bold shadow-lg shadow-indigo-500/30 hover:shadow-xl hover:shadow-indigo-500/40 transition-all transform hover:scale-105 active:scale-95 flex items-center gap-1.5">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-3.5 w-3.5 sm:h-4 sm:w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M12 4v16m8-8H4" />
              </svg>
              <span class="hidden sm:inline">Tambah</span>
            </button>
          </div>
        </div>
        
        <!-- Cart Table with Modern Design -->
        <div class="bg-white rounded-xl sm:rounded-2xl border border-gray-200 overflow-hidden mb-3 sm:mb-4 shadow-sm flex-shrink-0">
          <!-- Header -->
          <div class="bg-gradient-to-r from-gray-800 to-gray-900 text-white text-[9px] sm:text-xs uppercase tracking-wider font-bold">
            <div class="flex items-center px-3 sm:px-4 py-2.5 sm:py-3 gap-2 sm:gap-3">
              <div class="flex-1 min-w-0 flex items-center gap-1.5">
                <span class="text-gray-400">üì¶</span> Produk
              </div>
              <div class="w-14 sm:w-20 flex-shrink-0 text-center">Harga</div>
              <div class="w-8 sm:w-12 flex-shrink-0 text-center">Qty</div>
              <div class="w-16 sm:w-24 flex-shrink-0 text-right">Subtotal</div>
              <div class="w-6 sm:w-8 flex-shrink-0"></div>
            </div>
          </div>
          
          <!-- Scrollable Cart Items -->
          <div class="min-h-[100px] max-h-[180px] sm:max-h-[220px] overflow-y-auto bg-gray-50/50">
            <!-- Empty State -->
            <div x-show="cart.length === 0" class="py-8 sm:py-10 text-center bg-gradient-to-b from-gray-50 to-white">
              <div class="w-14 h-14 sm:w-16 sm:h-16 mx-auto bg-gradient-to-br from-gray-100 to-gray-200 rounded-2xl flex items-center justify-center mb-3 shadow-inner">
                <span class="text-2xl sm:text-3xl opacity-60">üõí</span>
              </div>
              <p class="text-gray-500 text-xs sm:text-sm font-medium">Keranjang masih kosong</p>
              <p class="text-gray-400 text-[10px] sm:text-xs mt-1">Pilih produk dari dropdown di atas</p>
            </div>
            
            <!-- Cart Items -->
            <template x-for="(item, idx) in cart" :key="idx">
              <div :class="item.promoApplied ? 'bg-gradient-to-r from-emerald-50 to-teal-50 border-l-4 border-l-emerald-500' : (item.hasPromo ? 'bg-gradient-to-r from-amber-50 to-orange-50 border-l-4 border-l-amber-400' : 'bg-white hover:bg-gray-50')" 
                   class="flex items-center px-3 sm:px-4 py-2.5 sm:py-3 border-b border-gray-100 last:border-b-0 transition-all duration-200 gap-2 sm:gap-3">
                <!-- Nama Produk -->
                <div class="flex-1 min-w-0">
                  <div class="flex flex-col">
                    <span x-text="item.name" class="text-gray-800 font-semibold text-[11px] sm:text-sm leading-tight truncate"></span>
                    <!-- Promo Applied Badge -->
                    <span x-show="item.promoApplied" class="inline-flex items-center gap-0.5 text-[8px] sm:text-[10px] bg-gradient-to-r from-emerald-500 to-teal-500 text-white px-1.5 sm:px-2 py-0.5 rounded-full w-fit mt-1 font-bold shadow-sm">
                      üè∑Ô∏è <span x-text="item.promoLabel || 'PROMO'"></span>
                    </span>
                    <!-- Promo Available but not applied -->
                    <span x-show="item.hasPromo && !item.promoApplied" class="inline-flex items-center gap-0.5 text-[8px] sm:text-[10px] bg-gradient-to-r from-amber-400 to-orange-400 text-white px-1.5 sm:px-2 py-0.5 rounded-full w-fit mt-1 font-bold shadow-sm">
                      ‚è≥ <span x-text="item.promoLabel || 'PROMO'"></span> <span class="opacity-75">(belum memenuhi syarat)</span>
                    </span>
                    <!-- Free Items info -->
                    <span x-show="item.freeItems > 0" class="text-[9px] sm:text-[10px] text-emerald-600 font-bold mt-0.5">
                      üéÅ +<span x-text="item.freeItems"></span> GRATIS!
                    </span>
                  </div>
                </div>
                
                <!-- Harga Satuan -->
                <div class="w-14 sm:w-20 flex-shrink-0 text-center">
                  <div class="flex flex-col items-center">
                    <span x-show="item.promoApplied && item.price !== item.originalPrice" class="text-gray-400 line-through text-[8px] sm:text-[10px]" x-text="formatRupiah(item.originalPrice)"></span>
                    <span :class="item.promoApplied ? 'text-emerald-600 font-bold text-[10px] sm:text-xs' : 'text-gray-700 text-[10px] sm:text-xs font-medium'" x-text="formatRupiah(item.price)"></span>
                  </div>
                </div>
                
                <!-- Qty -->
                <div class="w-8 sm:w-12 flex-shrink-0 text-center">
                  <div class="flex flex-col items-center gap-0.5">
                    <span class="inline-flex items-center justify-center bg-gradient-to-br from-indigo-500 to-purple-600 text-white font-bold text-[10px] sm:text-xs w-6 h-6 sm:w-7 sm:h-7 rounded-lg shadow-sm" x-text="item.qty"></span>
                    <span x-show="item.freeItems > 0" class="text-[8px] text-emerald-600 font-bold">
                      bayar <span x-text="item.effectiveQty"></span>
                    </span>
                  </div>
                </div>
                
                <!-- Subtotal -->
                <div class="w-16 sm:w-24 flex-shrink-0 text-right">
                  <div class="flex flex-col items-end">
                    <span x-show="item.promoApplied" class="text-gray-400 line-through text-[8px] sm:text-[10px]" x-text="formatRupiah(item.originalPrice * item.qty)"></span>
                    <span :class="item.promoApplied ? 'text-emerald-600 font-bold text-[10px] sm:text-xs' : 'text-gray-900 font-bold text-[10px] sm:text-xs'" x-text="formatRupiah(item.subtotal)"></span>
                    <span x-show="item.promoApplied && item.promoDiscount > 0" class="text-[8px] sm:text-[9px] text-emerald-500 font-medium">
                      hemat <span x-text="formatRupiah(item.promoDiscount)"></span>
                    </span>
                  </div>
                </div>
                
                <!-- Delete Button -->
                <div class="w-6 sm:w-8 flex-shrink-0 text-center">
                  <button @click="removeFromCart(idx)" class="w-6 h-6 sm:w-7 sm:h-7 rounded-lg bg-gray-100 hover:bg-red-100 text-gray-400 hover:text-red-500 transition-all flex items-center justify-center group">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3 sm:h-3.5 sm:w-3.5 transition-transform group-hover:scale-110" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                  </button>
                </div>
              </div>
            </template>
          </div>
        </div>
        
        <!-- Grand Total Card - Premium Design -->
        <div class="relative overflow-hidden bg-gradient-to-r from-indigo-600 via-purple-600 to-pink-500 rounded-xl sm:rounded-2xl p-3.5 sm:p-5 flex justify-between items-center mb-3 sm:mb-4 shadow-xl shadow-indigo-500/20 flex-shrink-0">
          <!-- Decorative circles -->
          <div class="absolute -top-6 -left-6 w-20 h-20 bg-white/10 rounded-full"></div>
          <div class="absolute -bottom-4 -right-4 w-16 h-16 bg-white/10 rounded-full"></div>
          
          <div class="relative flex items-center gap-2 sm:gap-3">
            <div class="w-9 h-9 sm:w-11 sm:h-11 bg-white/20 rounded-xl flex items-center justify-center backdrop-blur-sm">
              <span class="text-lg sm:text-xl">üíé</span>
            </div>
            <div>
              <span class="font-bold text-white/80 text-[10px] sm:text-xs uppercase tracking-widest block">Grand Total</span>
              <span x-show="cart.length > 0" class="text-white/60 text-[9px] sm:text-[10px]" x-text="cart.length + ' item'"></span>
            </div>
          </div>
          <div class="relative text-right">
            <span class="text-xl sm:text-3xl font-black text-white drop-shadow-lg" x-text="formatRupiah(cartTotal)"></span>
          </div>
        </div>

        <!-- Bottom Controls - Modern Cards -->
        <div class="grid grid-cols-1 sm:grid-cols-3 gap-2 sm:gap-3 flex-shrink-0">
          <!-- Reference Number -->
          <div class="bg-gray-50 rounded-xl p-3 border border-gray-200">
            <label class="text-[9px] sm:text-[10px] font-bold text-gray-500 uppercase tracking-wider flex items-center gap-1 mb-1.5">
              <span>üìù</span> No. Referensi
            </label>
            <input type="text" x-model="invoiceNote" 
              class="w-full bg-white border border-gray-200 rounded-lg p-2 sm:p-2.5 text-xs sm:text-sm focus:border-indigo-500 focus:ring-2 focus:ring-indigo-500/20 transition-all font-medium"
              placeholder="INV-001" />
          </div>
          
          <!-- Shipping -->
          <div class="bg-gray-50 rounded-xl p-3 border border-gray-200">
            <label class="text-[9px] sm:text-[10px] font-bold text-gray-500 uppercase tracking-wider flex items-center gap-1 mb-1.5">
              <span>üöö</span> Ongkos Kirim
            </label>
            <select x-model="selectedShippingIndex" 
              class="w-full bg-white border border-gray-200 rounded-lg p-2 sm:p-2.5 text-xs sm:text-sm focus:border-indigo-500 focus:ring-2 focus:ring-indigo-500/20 transition-all font-medium appearance-none cursor-pointer">
              <option value="">Tanpa Ongkir</option>
              <template x-for="(opt, idx) in shippingOptions" :key="idx">
                <option :value="idx" x-text="opt.label + ' - ' + formatRupiah(opt.price)"></option>
              </template>
            </select>
          </div>
          
          <!-- Mark as Paid -->
          <div @click="isPaid = !isPaid" 
            :class="isPaid ? 'bg-gradient-to-r from-emerald-500 to-teal-500 border-emerald-400' : 'bg-gray-50 border-gray-200 hover:border-emerald-300 hover:bg-emerald-50'"
            class="rounded-xl p-3 border cursor-pointer transition-all duration-300 flex items-center justify-center gap-2 group">
            <div :class="isPaid ? 'bg-white/30' : 'bg-gray-200 group-hover:bg-emerald-200'" 
              class="w-5 h-5 sm:w-6 sm:h-6 rounded-lg flex items-center justify-center transition-all">
              <svg x-show="isPaid" xmlns="http://www.w3.org/2000/svg" class="h-3 w-3 sm:h-4 sm:w-4 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7" />
              </svg>
            </div>
            <span :class="isPaid ? 'text-white' : 'text-gray-600 group-hover:text-emerald-700'" 
              class="text-xs sm:text-sm font-bold transition-colors whitespace-nowrap">
              ‚úÖ Tandai LUNAS
            </span>
            <input type="checkbox" x-model="isPaid" class="hidden" />
          </div>
        </div>
      </div>

      <!-- Tab: Unpaid Invoices -->
      <div x-show="invoiceTab === 'unpaid'" class="flex-1 overflow-y-auto px-4 sm:px-6 py-3 sm:py-4">
        <template x-for="inv in unpaidInvoices" :key="inv.id">
          <div class="bg-gradient-to-r from-orange-50 to-amber-50 border border-orange-200 p-3 sm:p-4 rounded-xl sm:rounded-2xl mb-2 sm:mb-3 hover:shadow-md transition-all group">
            <div class="flex justify-between items-start mb-2 sm:mb-3">
              <div>
                <div class="font-bold text-gray-800 text-sm sm:text-base" x-text="inv.invoiceNote || inv.id"></div>
                <div class="text-[10px] sm:text-xs text-gray-500 flex items-center gap-1.5 mt-0.5"
                  x-text="inv.customerName + ' ‚Ä¢ ' + new Date(inv.date).toLocaleDateString('id-ID')"></div>
              </div>
              <span class="px-2 py-1 bg-orange-100 text-orange-700 rounded-lg text-[10px] sm:text-xs font-bold">‚è≥ Pending</span>
            </div>
            <div class="flex justify-between items-center">
              <div class="text-lg sm:text-xl font-black bg-gradient-to-r from-orange-600 to-amber-600 bg-clip-text text-transparent" x-text="formatRupiah(inv.total)"></div>
              <div class="flex gap-1.5 sm:gap-2">
                <button @click="sendInvoiceReminder(inv.id)"
                  class="bg-amber-100 hover:bg-amber-200 text-amber-700 border border-amber-200 px-2.5 sm:px-3 py-1.5 sm:py-2 rounded-lg text-[10px] sm:text-xs font-bold transition-all flex items-center gap-1 hover:shadow-sm"
                  title="Kirim Reminder">
                  <span>üîî</span>
                  <span class="hidden sm:inline">Ingatkan</span>
                </button>
                <button @click="markAsPaid(inv.id)"
                  class="bg-gradient-to-r from-emerald-500 to-teal-500 hover:from-emerald-600 hover:to-teal-600 text-white px-2.5 sm:px-4 py-1.5 sm:py-2 rounded-lg text-[10px] sm:text-xs font-bold transition-all flex items-center gap-1 shadow-md shadow-emerald-500/30 hover:shadow-lg">
                  <span>‚úÖ</span>
                  <span>LUNAS</span>
                </button>
              </div>
            </div>
          </div>
        </template>
        <div x-show="unpaidInvoices.length === 0" class="text-center py-10 sm:py-12">
          <div class="w-16 h-16 sm:w-20 sm:h-20 mx-auto bg-gradient-to-br from-green-100 to-emerald-200 rounded-2xl flex items-center justify-center mb-3 sm:mb-4">
            <span class="text-3xl sm:text-4xl">üéâ</span>
          </div>
          <p class="text-gray-600 font-semibold text-sm sm:text-base">Semua Tagihan Lunas!</p>
          <p class="text-gray-400 text-xs sm:text-sm mt-1">Tidak ada tagihan yang belum dibayar</p>
        </div>
      </div>

      <!-- Footer Actions - Premium Design - Fixed, no shrink -->
      <div x-show="invoiceTab === 'new'" class="flex-shrink-0 px-4 sm:px-6 py-3 sm:py-4 bg-gradient-to-b from-gray-50 to-gray-100 border-t border-gray-200 flex justify-end gap-2 sm:gap-3 rounded-b-2xl sm:rounded-b-3xl">
        <button @click="showInvoiceModal = false" 
          class="px-4 sm:px-5 py-2 sm:py-2.5 text-gray-600 text-xs sm:text-sm font-semibold hover:bg-gray-200 rounded-lg sm:rounded-xl transition-all">
          Batal
        </button>
        <button @click="sendInvoice" :disabled="cart.length === 0"
          class="px-5 sm:px-6 py-2 sm:py-2.5 bg-gradient-to-r from-emerald-500 to-teal-500 hover:from-emerald-600 hover:to-teal-600 text-white text-xs sm:text-sm font-bold rounded-lg sm:rounded-xl disabled:opacity-50 disabled:cursor-not-allowed transition-all shadow-lg shadow-emerald-500/30 hover:shadow-xl hover:shadow-emerald-500/40 disabled:shadow-none flex items-center gap-2 transform hover:scale-[1.02] active:scale-[0.98]"
          id="btn-send-invoice">
          <span>Kirim Invoice</span>
          <span class="text-base">üöÄ</span>
        </button>
      </div>
    </div>
  </div>

  <div x-show="showCRMModal" x-transition
    class="fixed inset-0 z-[65] bg-black bg-opacity-50 flex items-center justify-center p-4" x-cloak>
    <div class="bg-white rounded-xl w-full max-w-sm p-6 shadow-2xl relative">
      <button @click="showCRMModal = false" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600">
        ‚úï
      </button>
      <h2 class="text-lg font-bold text-gray-800 mb-4">Edit Info Customer</h2>
      <div class="mb-4">
        <label class="block text-xs font-bold text-gray-600 mb-1">Label</label>
        <select x-model="tempLabel" class="w-full border border-gray-300 rounded p-2 text-sm">
          <option value="General">General</option>
          <option value="Lead">Lead (Calon)</option>
          <option value="Hot">Hot Prospect üî•</option>
          <option value="Pending">Pending Payment ‚è≥</option>
          <option value="Lunas">Lunas ‚úÖ</option>
          <option value="VIP">VIP üåü</option>
          <option value="Complain">Complain ‚ö†Ô∏è</option>
        </select>
      </div>
      <div class="mb-6">
        <label class="block text-xs font-bold text-gray-600 mb-1">Catatan</label>
        <textarea x-model="tempNote" rows="3" class="w-full border border-gray-300 rounded p-2 text-sm resize-none"
          placeholder="Catatan khusus customer ini..."></textarea>
      </div>
      <button @click="saveCRM" class="w-full bg-blue-600 text-white font-bold py-2 rounded hover:bg-blue-700">
        Simpan Perubahan
      </button>
    </div>
  </div>

  <div x-show="showBroadcastModal" x-transition
    class="fixed inset-0 z-[65] bg-black bg-opacity-50 flex items-center justify-center p-4" x-cloak>
    <div class="bg-white rounded-xl w-full max-w-lg p-6 shadow-2xl relative">
      <button @click="showBroadcastModal = false" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600">
        ‚úï
      </button>
      <h2 class="text-lg font-bold text-gray-800 mb-1">Broadcast Pesan üì¢</h2>
      <p class="text-xs text-gray-500 mb-4">
        Kirim pesan massal ke kontak berdasarkan label.
      </p>
      <div class="mb-4">
        <label class="block text-xs font-bold text-gray-600 mb-1">Target Penerima</label>
        <select x-model="broadcastTarget" class="w-full border border-gray-300 rounded p-2 text-sm">
          <option value="all">Semua Kontak (Di CRM)</option>
          <option value="manual">Input Manual (Nomor HP)</option>
          <option value="Lead">Label: Lead</option>
          <option value="Hot">Label: Hot Prospect</option>
          <option value="Pending">Label: Pending Payment</option>
          <option value="Lunas">Label: Lunas</option>
          <option value="VIP">Label: VIP</option>
        </select>
      </div>
      <div class="mb-4" x-show="broadcastTarget === 'manual'">
        <label class="block text-xs font-bold text-gray-600 mb-1">Daftar Nomor (Pisahkan dengan Enter atau Koma)</label>
        <textarea x-model="manualNumbers" rows="3" class="w-full border border-gray-300 rounded p-2 text-sm"
          placeholder="081234567890&#10;6281234567890"></textarea>
      </div>
      <div class="mb-4">
        <label class="block text-xs font-bold text-gray-600 mb-1">Isi Pesan</label>
        <textarea x-model="broadcastMsg" rows="5" class="w-full border border-gray-300 rounded p-2 text-sm"
          placeholder="Tulis pesan promo/info disini..."></textarea>
      </div>
      <button @click="sendBroadcast" :disabled="!broadcastMsg"
        class="w-full bg-orange-600 text-white font-bold py-2 rounded hover:bg-orange-700 disabled:opacity-50">
        Kirim Broadcast üöÄ
      </button>
    </div>
  </div>

  <!-- Schedule Modal -->
  <div x-show="showScheduleModal" x-transition
    class="fixed inset-0 z-[70] bg-black bg-opacity-50 flex items-center justify-center p-4" x-cloak>
    <div class="bg-white rounded-xl w-full max-w-md p-6 shadow-2xl relative">
      <button @click="showScheduleModal = false" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600">
        ‚úï
      </button>
      <h2 class="text-lg font-bold text-gray-800 mb-4" x-text="scheduleForm.id ? 'Edit Jadwal' : 'Buat Jadwal Baru'">
      </h2>

      <div class="space-y-4">
        <div>
          <label class="block text-xs font-bold text-gray-600 mb-1">Judul</label>
          <input type="text" x-model="scheduleForm.title" class="w-full border border-gray-300 rounded p-2 text-sm"
            placeholder="Contoh: Follow Up Customer" />
        </div>

        <div class="grid grid-cols-2 gap-4">
          <div>
            <label class="block text-xs font-bold text-gray-600 mb-1">Tanggal</label>
            <input type="date" x-model="scheduleForm.date" class="w-full border border-gray-300 rounded p-2 text-sm" />
          </div>
          <div>
            <label class="block text-xs font-bold text-gray-600 mb-1">Waktu</label>
            <input type="time" x-model="scheduleForm.time" class="w-full border border-gray-300 rounded p-2 text-sm" />
          </div>
        </div>

        <div>
          <label class="block text-xs font-bold text-gray-600 mb-1">Deskripsi</label>
          <textarea x-model="scheduleForm.description" rows="3"
            class="w-full border border-gray-300 rounded p-2 text-sm resize-none"
            placeholder="Detail kegiatan..."></textarea>
        </div>

        <div>
          <label class="block text-xs font-bold text-gray-600 mb-1">Customer (Opsional)</label>
          <input type="text" x-model="scheduleForm.customerDisplay"
            class="w-full border border-gray-300 rounded p-2 text-sm bg-gray-50" placeholder="Nomor HP Customer"
            readonly />
          <p class="text-[10px] text-gray-400 mt-1">
            Otomatis terisi jika membuka dari chat.
          </p>
        </div>

        <button @click="saveSchedule"
          class="w-full bg-blue-600 text-white font-bold py-2 rounded hover:bg-blue-700 transition">
          Simpan Jadwal
        </button>
      </div>
    </div>
  </div>

  <!-- BROADCAST SCHEDULE MODAL -->
  <div x-show="showBroadcastScheduleModal" x-transition
    class="fixed inset-0 z-[60] bg-black bg-opacity-50 flex items-center justify-center p-4" x-cloak>
    <div class="glass-panel rounded-2xl w-full max-w-lg p-4 sm:p-6 shadow-2xl relative max-h-[90vh] overflow-y-auto">
      <button @click="showBroadcastScheduleModal = false"
        class="absolute top-3 right-3 sm:top-4 sm:right-4 text-gray-400 hover:text-gray-600 z-10">
        ‚úï
      </button>
      <h2 class="text-base sm:text-lg font-bold text-gray-800 mb-1 flex items-center gap-2 pr-8">
        üì¢
        <span x-text="broadcastScheduleForm.id ? 'Edit Broadcast' : 'Jadwalkan Broadcast'"></span>
      </h2>
      <p class="text-xs sm:text-sm text-gray-500 mb-3 sm:mb-4">
        Atur waktu pengiriman pesan massal otomatis
      </p>

      <div class="space-y-3 sm:space-y-4">
        <!-- Title -->
        <div>
          <label class="block text-xs font-bold text-gray-600 mb-1">Judul Broadcast</label>
          <input type="text" x-model="broadcastScheduleForm.title"
            class="w-full border border-gray-300 rounded-lg p-2.5 sm:p-3 text-sm focus:ring-2 focus:ring-orange-500 outline-none"
            placeholder="Contoh: Promo Akhir Tahun" />
        </div>

        <!-- Message -->
        <div>
          <label class="block text-xs font-bold text-gray-600 mb-1">Isi Pesan</label>
          <textarea x-model="broadcastScheduleForm.message" rows="3"
            class="w-full border border-gray-300 rounded-lg p-2.5 sm:p-3 text-sm focus:ring-2 focus:ring-orange-500 outline-none resize-none"
            placeholder="Tulis pesan broadcast di sini..."></textarea>
        </div>

        <!-- Target Selection -->
        <div>
          <label class="block text-xs font-bold text-gray-600 mb-2">Target Penerima</label>
          <!-- Main Target Type Buttons -->
          <div class="grid grid-cols-3 gap-2 mb-3">
            <button type="button"
              @click="broadcastScheduleForm.targetLabel = 'all'; broadcastScheduleForm.manualNumbers = ''"
              :class="broadcastScheduleForm.targetLabel === 'all' ? 'bg-orange-500 text-white shadow-md' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'"
              class="px-3 py-2 rounded-lg text-xs font-bold transition">
              üì± Semua
            </button>
            <button type="button"
              @click="broadcastScheduleForm.targetLabel = 'label'; broadcastScheduleForm.manualNumbers = ''"
              :class="broadcastScheduleForm.targetLabel === 'label' || ['Hot','Warm','Cold','General'].includes(broadcastScheduleForm.targetLabel) ? 'bg-blue-500 text-white shadow-md' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'"
              class="px-3 py-2 rounded-lg text-xs font-bold transition">
              üè∑Ô∏è Label CRM
            </button>
            <button type="button" @click="broadcastScheduleForm.targetLabel = 'manual'"
              :class="broadcastScheduleForm.targetLabel === 'manual' ? 'bg-purple-500 text-white shadow-md' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'"
              class="px-3 py-2 rounded-lg text-xs font-bold transition">
              ‚úçÔ∏è Manual
            </button>
          </div>

          <!-- Label CRM Selection -->
          <div
            x-show="broadcastScheduleForm.targetLabel === 'label' || ['Lead','Hot','Pending','Lunas','VIP','Complain','General'].includes(broadcastScheduleForm.targetLabel)"
            x-transition class="mb-2">
            <div class="grid grid-cols-2 sm:grid-cols-4 gap-1.5 sm:gap-2 mb-2">
              <button type="button" @click="broadcastScheduleForm.targetLabel = 'Lead'"
                :class="broadcastScheduleForm.targetLabel === 'Lead' ? 'ring-2 ring-blue-400 bg-blue-100' : 'bg-blue-50'"
                class="px-2 py-2 rounded-lg text-xs font-bold text-blue-700 transition hover:bg-blue-100">
                üìã Lead
              </button>
              <button type="button" @click="broadcastScheduleForm.targetLabel = 'Hot'"
                :class="broadcastScheduleForm.targetLabel === 'Hot' ? 'ring-2 ring-orange-400 bg-orange-100' : 'bg-orange-50'"
                class="px-2 py-2 rounded-lg text-xs font-bold text-orange-700 transition hover:bg-orange-100">
                üî• Hot
              </button>
              <button type="button" @click="broadcastScheduleForm.targetLabel = 'Pending'"
                :class="broadcastScheduleForm.targetLabel === 'Pending' ? 'ring-2 ring-yellow-400 bg-yellow-100' : 'bg-yellow-50'"
                class="px-2 py-2 rounded-lg text-xs font-bold text-yellow-700 transition hover:bg-yellow-100">
                ‚è≥ Pending
              </button>
              <button type="button" @click="broadcastScheduleForm.targetLabel = 'Lunas'"
                :class="broadcastScheduleForm.targetLabel === 'Lunas' ? 'ring-2 ring-green-400 bg-green-100' : 'bg-green-50'"
                class="px-2 py-2 rounded-lg text-xs font-bold text-green-700 transition hover:bg-green-100">
                ‚úÖ Lunas
              </button>
            </div>
            <div class="grid grid-cols-3 gap-1.5 sm:gap-2">
              <button type="button" @click="broadcastScheduleForm.targetLabel = 'VIP'"
                :class="broadcastScheduleForm.targetLabel === 'VIP' ? 'ring-2 ring-purple-400 bg-purple-100' : 'bg-purple-50'"
                class="px-2 py-2 rounded-lg text-xs font-bold text-purple-700 transition hover:bg-purple-100">
                üëë VIP
              </button>
              <button type="button" @click="broadcastScheduleForm.targetLabel = 'Complain'"
                :class="broadcastScheduleForm.targetLabel === 'Complain' ? 'ring-2 ring-red-400 bg-red-100' : 'bg-red-50'"
                class="px-2 py-2 rounded-lg text-xs font-bold text-red-700 transition hover:bg-red-100">
                ‚ö†Ô∏è Complain
              </button>
              <button type="button" @click="broadcastScheduleForm.targetLabel = 'General'"
                :class="broadcastScheduleForm.targetLabel === 'General' ? 'ring-2 ring-gray-400 bg-gray-200' : 'bg-gray-100'"
                class="px-2 py-2 rounded-lg text-xs font-bold text-gray-700 transition hover:bg-gray-200">
                üìå General
              </button>
            </div>
            <p class="text-xs text-gray-400 mt-2">
              üì® Pesan akan dikirim ke semua kontak dengan label yang dipilih
            </p>
          </div>

          <!-- Manual Numbers Input -->
          <div x-show="broadcastScheduleForm.targetLabel === 'manual'" x-transition>
            <textarea x-model="broadcastScheduleForm.manualNumbers" rows="2"
              class="w-full border border-gray-300 rounded-lg p-3 text-sm focus:ring-2 focus:ring-purple-500 outline-none resize-none"
              placeholder="Pisahkan dengan koma atau enter:&#10;081234567890&#10;089876543210"></textarea>
            <p class="text-xs text-gray-400 mt-1">
              Format: 08xxx atau 628xxx, pisahkan dengan koma atau enter
            </p>
          </div>
        </div>

        <!-- Send Now / Schedule Toggle -->
        <div class="flex items-center gap-3 p-3 bg-gray-50 rounded-xl">
          <label class="flex items-center gap-2 cursor-pointer flex-1">
            <input type="radio" name="broadcastMode" value="now" x-model="broadcastScheduleForm.sendNow"
              :checked="broadcastScheduleForm.sendNow === 'now'" class="accent-green-600 w-4 h-4" />
            <span class="text-sm font-bold text-gray-700">üöÄ Kirim Sekarang</span>
          </label>
          <label class="flex items-center gap-2 cursor-pointer flex-1">
            <input type="radio" name="broadcastMode" value="schedule" x-model="broadcastScheduleForm.sendNow"
              :checked="broadcastScheduleForm.sendNow === 'schedule'" class="accent-orange-600 w-4 h-4" />
            <span class="text-sm font-bold text-gray-700">üìÖ Jadwalkan</span>
          </label>
        </div>

        <!-- Date & Time (only show if schedule) -->
        <div x-show="broadcastScheduleForm.sendNow === 'schedule'" x-transition class="grid grid-cols-2 gap-2 sm:gap-4">
          <div>
            <label class="block text-xs font-bold text-gray-600 mb-1">Tanggal</label>
            <input type="date" x-model="broadcastScheduleForm.scheduledDate"
              class="w-full border border-gray-300 rounded-lg p-2.5 sm:p-3 text-sm focus:ring-2 focus:ring-orange-500 outline-none" />
          </div>
          <div>
            <label class="block text-xs font-bold text-gray-600 mb-1">Waktu</label>
            <input type="time" x-model="broadcastScheduleForm.scheduledTime"
              class="w-full border border-gray-300 rounded-lg p-2.5 sm:p-3 text-sm focus:ring-2 focus:ring-orange-500 outline-none" />
          </div>
        </div>

        <!-- Submit Buttons -->
        <button x-show="broadcastScheduleForm.sendNow === 'now'" @click="sendBroadcastNow"
          class="w-full bg-gradient-to-r from-green-500 to-emerald-600 text-white font-bold py-2.5 sm:py-3 rounded-xl hover:shadow-lg transition flex items-center justify-center gap-2 text-sm sm:text-base">
          <span>üöÄ</span>
          <span>Kirim Broadcast Sekarang</span>
        </button>
        <button x-show="broadcastScheduleForm.sendNow === 'schedule'" @click="saveBroadcastSchedule"
          class="w-full bg-gradient-to-r from-orange-500 to-pink-500 text-white font-bold py-2.5 sm:py-3 rounded-xl hover:shadow-lg transition flex items-center justify-center gap-2 text-sm sm:text-base">
          <span>üìÖ</span>
          <span x-text="broadcastScheduleForm.id ? 'Perbarui Broadcast' : 'Jadwalkan Broadcast'"></span>
        </button>
      </div>
    </div>
  </div>

  <script src="/js/script.js"></script>
</body>

</html>