<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Developer Dashboard - NayooAI</title>
    <script
      defer
      src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"
    ></script>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap"
      rel="stylesheet"
    />
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="/css/style.css" />
    <style>
      [x-cloak] {
        display: none !important;
      }

      body {
        font-family: "Plus Jakarta Sans", sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
      }

      .glass-card {
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(20px);
        border: 1px solid rgba(255, 255, 255, 0.3);
      }

      .status-badge {
        font-size: 10px;
        font-weight: 700;
        padding: 4px 10px;
        border-radius: 9999px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }

      .status-active {
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        color: white;
      }

      .status-expired {
        background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        color: white;
      }

      .status-expiring {
        background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        color: white;
      }

      .status-unlimited {
        background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
        color: white;
      }

      .countdown-ring {
        position: relative;
        width: 60px;
        height: 60px;
      }

      .countdown-ring svg {
        transform: rotate(-90deg);
      }

      .countdown-ring .progress {
        stroke-linecap: round;
        transition: stroke-dasharray 0.5s ease;
      }

      .user-row {
        transition: all 0.3s ease;
      }

      .user-row:hover {
        background: rgba(99, 102, 241, 0.05);
        transform: translateX(4px);
      }

      .action-btn {
        transition: all 0.2s ease;
      }

      .action-btn:hover {
        transform: translateY(-2px);
      }

      .input-modern {
        background: rgba(249, 250, 251, 0.8);
        border: 2px solid transparent;
        transition: all 0.3s ease;
      }

      .input-modern:focus {
        border-color: #6366f1;
        box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.1);
      }
    </style>
  </head>

  <body class="p-4 md:p-8" x-data="developerDashboard()">
    <!-- Toast Container -->
    <div id="toast-container" class="toast-container"></div>

    <!-- Header -->
    <div class="max-w-7xl mx-auto mb-8">
      <div
        class="flex flex-col md:flex-row md:items-center md:justify-between gap-4"
      >
        <div>
          <h1
            class="text-3xl md:text-4xl font-extrabold text-white drop-shadow-lg"
          >
            üõ†Ô∏è Developer Dashboard
          </h1>
          <p class="text-white/80 mt-2">
            Kelola subscription dan monitor semua user
          </p>
        </div>
        <div class="flex items-center gap-3">
          <button
            @click="fetchUsers"
            class="bg-white/20 hover:bg-white/30 text-white px-4 py-2 rounded-xl font-bold flex items-center gap-2 transition backdrop-blur-sm"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              class="h-5 w-5"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"
              />
            </svg>
            Refresh
          </button>
          <a
            href="/index.html"
            class="bg-white text-indigo-600 px-4 py-2 rounded-xl font-bold flex items-center gap-2 hover:shadow-lg transition"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              class="h-5 w-5"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"
              />
            </svg>
            Dashboard User
          </a>
        </div>
      </div>
    </div>

    <!-- Stats Cards -->
    <div class="max-w-7xl mx-auto mb-8">
      <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
        <div class="glass-card rounded-2xl p-5 shadow-xl">
          <div class="flex items-center justify-between mb-3">
            <span class="text-3xl">üë•</span>
            <span class="text-xs font-bold text-gray-400 uppercase">Total</span>
          </div>
          <p class="text-3xl font-extrabold text-gray-800" x-text="stats.total">
            0
          </p>
          <p class="text-xs text-gray-500 mt-1">Pengguna Terdaftar</p>
        </div>

        <div class="glass-card rounded-2xl p-5 shadow-xl">
          <div class="flex items-center justify-between mb-3">
            <span class="text-3xl">‚úÖ</span>
            <span class="text-xs font-bold text-emerald-500 uppercase"
              >Active</span
            >
          </div>
          <p
            class="text-3xl font-extrabold text-emerald-600"
            x-text="stats.active"
          >
            0
          </p>
          <p class="text-xs text-gray-500 mt-1">Aktif Berlangganan</p>
        </div>

        <div class="glass-card rounded-2xl p-5 shadow-xl">
          <div class="flex items-center justify-between mb-3">
            <span class="text-3xl">‚ö†Ô∏è</span>
            <span class="text-xs font-bold text-amber-500 uppercase"
              >Expiring</span
            >
          </div>
          <p
            class="text-3xl font-extrabold text-amber-600"
            x-text="stats.expiring"
          >
            0
          </p>
          <p class="text-xs text-gray-500 mt-1">Hampir Berakhir</p>
        </div>

        <div class="glass-card rounded-2xl p-5 shadow-xl">
          <div class="flex items-center justify-between mb-3">
            <span class="text-3xl">‚ùå</span>
            <span class="text-xs font-bold text-red-500 uppercase"
              >Expired</span
            >
          </div>
          <p
            class="text-3xl font-extrabold text-red-600"
            x-text="stats.expired"
          >
            0
          </p>
          <p class="text-xs text-gray-500 mt-1">Sudah Berakhir</p>
        </div>
      </div>
    </div>

    <!-- AI Provider Status Panel -->
    <div class="max-w-7xl mx-auto mb-8">
      <div class="glass-card rounded-2xl p-5 shadow-xl">
        <div class="flex items-center justify-between mb-4">
          <div class="flex items-center gap-2">
            <span class="text-2xl">ü§ñ</span>
            <h3 class="text-lg font-bold text-gray-800">Status AI Provider</h3>
          </div>
          <div class="flex gap-2">
            <button
              @click="fetchAIStatus"
              class="text-xs bg-gray-100 hover:bg-gray-200 text-gray-600 px-3 py-1 rounded-lg font-medium transition"
            >
              üîÑ Refresh
            </button>
            <button
              @click="resetAllProviders"
              class="text-xs bg-indigo-100 hover:bg-indigo-200 text-indigo-700 px-3 py-1 rounded-lg font-medium transition"
            >
              ‚ôªÔ∏è Reset All
            </button>
          </div>
        </div>

        <!-- Manual Provider Selector -->
        <div
          class="mb-4 p-4 rounded-xl bg-gradient-to-r from-indigo-50 to-purple-50 border border-indigo-200"
        >
          <div class="flex flex-col md:flex-row md:items-center gap-3">
            <div class="flex items-center gap-2">
              <span class="text-xl">üéõÔ∏è</span>
              <span class="font-bold text-gray-800">Manual Switch:</span>
            </div>
            <div class="flex flex-wrap items-center gap-2 flex-1">
              <select
                x-model="preferredProvider"
                @change="setPreferredProvider(preferredProvider)"
                class="px-3 py-2 rounded-lg border border-indigo-300 bg-white text-sm font-medium text-gray-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 cursor-pointer"
              >
                <option value="auto">üîÑ AUTO (Fallback Order)</option>
                <option value="groq">‚ö° Groq (Primary)</option>
                <option value="sambanova">üöÄ SambaNova</option>
                <option value="gemini">‚ú® Gemini</option>
                <option value="openrouter">üåê OpenRouter</option>
                <option value="puter">üÜì Puter (Free)</option>
              </select>
              <span
                class="text-xs px-2 py-1 rounded-full font-medium"
                :class="preferredProvider === 'auto' ? 'bg-gray-100 text-gray-600' : 'bg-indigo-100 text-indigo-700'"
                x-text="preferredProvider === 'auto' ? 'Automatic fallback' : 'Manual: ' + preferredProvider.toUpperCase() + ' first'"
              ></span>
            </div>
          </div>
          <p class="text-[10px] text-gray-500 mt-2">
            üí° Pilih provider manual untuk prioritaskan, atau gunakan AUTO untuk
            fallback otomatis saat ada rate limit.
          </p>
        </div>

        <div class="grid grid-cols-2 md:grid-cols-5 gap-4">
          <!-- Groq -->
          <div
            class="relative p-4 rounded-xl border-2 transition-all"
            :class="aiStatus.groq?.available ? 'border-emerald-200 bg-emerald-50' : 'border-red-200 bg-red-50'"
          >
            <div class="flex items-center justify-between mb-2">
              <div class="flex items-center gap-2">
                <div
                  class="w-3 h-3 rounded-full animate-pulse"
                  :class="aiStatus.groq?.available ? 'bg-emerald-500' : 'bg-red-500'"
                ></div>
                <span class="font-bold text-gray-800">Groq</span>
                <span
                  class="text-[10px] bg-blue-100 text-blue-700 px-2 py-0.5 rounded-full font-medium"
                  >Primary</span
                >
              </div>
              <button
                @click="resetProvider('groq')"
                class="text-xs bg-white hover:bg-gray-50 text-gray-600 px-2 py-1 rounded shadow-sm transition"
                x-show="!aiStatus.groq?.available"
              >
                Reset
              </button>
            </div>
            <p
              class="text-xs font-medium"
              :class="aiStatus.groq?.available ? 'text-emerald-600' : 'text-red-600'"
              x-text="aiStatus.groq?.available ? '‚úì Available' : '‚úï Rate Limited'"
            ></p>
            <p
              class="text-[10px] text-gray-500 mt-1"
              x-show="!aiStatus.groq?.available && aiStatus.groq?.remainingCooldownSeconds > 0"
            >
              Retry in:
              <span
                class="font-bold"
                x-text="formatCooldown(aiStatus.groq?.remainingCooldownSeconds)"
              ></span>
            </p>
            <p
              class="text-[10px] text-gray-400 mt-1"
              x-show="aiStatus.groq?.lastError && !aiStatus.groq?.available"
              x-text="'Error: ' + aiStatus.groq?.lastError"
            ></p>
          </div>

          <!-- SambaNova -->
          <div
            class="relative p-4 rounded-xl border-2 transition-all"
            :class="aiStatus.sambanova?.available ? 'border-emerald-200 bg-emerald-50' : 'border-red-200 bg-red-50'"
          >
            <div class="flex items-center justify-between mb-2">
              <div class="flex items-center gap-2">
                <div
                  class="w-3 h-3 rounded-full animate-pulse"
                  :class="aiStatus.sambanova?.available ? 'bg-emerald-500' : 'bg-red-500'"
                ></div>
                <span class="font-bold text-gray-800">SambaNova</span>
                <span
                  class="text-[10px] bg-amber-100 text-amber-700 px-2 py-0.5 rounded-full font-medium"
                  >Backup 1</span
                >
              </div>
              <button
                @click="resetProvider('sambanova')"
                class="text-xs bg-white hover:bg-gray-50 text-gray-600 px-2 py-1 rounded shadow-sm transition"
                x-show="!aiStatus.sambanova?.available"
              >
                Reset
              </button>
            </div>
            <p
              class="text-xs font-medium"
              :class="aiStatus.sambanova?.available ? 'text-emerald-600' : 'text-red-600'"
              x-text="aiStatus.sambanova?.available ? '‚úì Available' : '‚úï Rate Limited'"
            ></p>
            <p
              class="text-[10px] text-gray-500 mt-1"
              x-show="!aiStatus.sambanova?.available && aiStatus.sambanova?.remainingCooldownSeconds > 0"
            >
              Retry in:
              <span
                class="font-bold"
                x-text="formatCooldown(aiStatus.sambanova?.remainingCooldownSeconds)"
              ></span>
            </p>
            <p
              class="text-[10px] text-gray-400 mt-1"
              x-show="aiStatus.sambanova?.lastError && !aiStatus.sambanova?.available"
              x-text="'Error: ' + aiStatus.sambanova?.lastError"
            ></p>
          </div>

          <!-- Gemini -->
          <div
            class="relative p-4 rounded-xl border-2 transition-all"
            :class="aiStatus.gemini?.available ? 'border-emerald-200 bg-emerald-50' : 'border-red-200 bg-red-50'"
          >
            <div class="flex items-center justify-between mb-2">
              <div class="flex items-center gap-2">
                <div
                  class="w-3 h-3 rounded-full animate-pulse"
                  :class="aiStatus.gemini?.available ? 'bg-emerald-500' : 'bg-red-500'"
                ></div>
                <span class="font-bold text-gray-800">Gemini</span>
                <span
                  class="text-[10px] bg-purple-100 text-purple-700 px-2 py-0.5 rounded-full font-medium"
                  >Backup 2</span
                >
              </div>
              <button
                @click="resetProvider('gemini')"
                class="text-xs bg-white hover:bg-gray-50 text-gray-600 px-2 py-1 rounded shadow-sm transition"
                x-show="!aiStatus.gemini?.available"
              >
                Reset
              </button>
            </div>
            <p
              class="text-xs font-medium"
              :class="aiStatus.gemini?.available ? 'text-emerald-600' : 'text-red-600'"
              x-text="aiStatus.gemini?.available ? '‚úì Available' : '‚úï Rate Limited'"
            ></p>
            <p
              class="text-[10px] text-gray-500 mt-1"
              x-show="!aiStatus.gemini?.available && aiStatus.gemini?.remainingCooldownSeconds > 0"
            >
              Retry in:
              <span
                class="font-bold"
                x-text="formatCooldown(aiStatus.gemini?.remainingCooldownSeconds)"
              ></span>
            </p>
            <p
              class="text-[10px] text-gray-400 mt-1"
              x-show="aiStatus.gemini?.lastError && !aiStatus.gemini?.available"
              x-text="'Error: ' + aiStatus.gemini?.lastError"
            ></p>
          </div>

          <!-- OpenRouter -->
          <div
            class="relative p-4 rounded-xl border-2 transition-all"
            :class="aiStatus.openrouter?.available ? 'border-emerald-200 bg-emerald-50' : 'border-red-200 bg-red-50'"
          >
            <div class="flex items-center justify-between mb-2">
              <div class="flex items-center gap-2">
                <div
                  class="w-3 h-3 rounded-full animate-pulse"
                  :class="aiStatus.openrouter?.available ? 'bg-emerald-500' : 'bg-red-500'"
                ></div>
                <span class="font-bold text-gray-800">OpenRouter</span>
                <span
                  class="text-[10px] bg-pink-100 text-pink-700 px-2 py-0.5 rounded-full font-medium"
                  >Backup 3</span
                >
              </div>
              <button
                @click="resetProvider('openrouter')"
                class="text-xs bg-white hover:bg-gray-50 text-gray-600 px-2 py-1 rounded shadow-sm transition"
                x-show="!aiStatus.openrouter?.available"
              >
                Reset
              </button>
            </div>
            <p
              class="text-xs font-medium"
              :class="aiStatus.openrouter?.available ? 'text-emerald-600' : 'text-red-600'"
              x-text="aiStatus.openrouter?.available ? '‚úì Available' : '‚úï Rate Limited'"
            ></p>
            <p
              class="text-[10px] text-gray-500 mt-1"
              x-show="!aiStatus.openrouter?.available && aiStatus.openrouter?.remainingCooldownSeconds > 0"
            >
              Retry in:
              <span
                class="font-bold"
                x-text="formatCooldown(aiStatus.openrouter?.remainingCooldownSeconds)"
              ></span>
            </p>
            <p
              class="text-[10px] text-gray-400 mt-1"
              x-show="aiStatus.openrouter?.lastError && !aiStatus.openrouter?.available"
              x-text="'Error: ' + aiStatus.openrouter?.lastError"
            ></p>
          </div>

          <!-- Puter -->
          <div
            class="relative p-4 rounded-xl border-2 transition-all"
            :class="aiStatus.puter?.available ? 'border-emerald-200 bg-emerald-50' : 'border-red-200 bg-red-50'"
          >
            <div class="flex items-center justify-between mb-2">
              <div class="flex items-center gap-2">
                <div
                  class="w-3 h-3 rounded-full animate-pulse"
                  :class="aiStatus.puter?.available ? 'bg-emerald-500' : 'bg-red-500'"
                ></div>
                <span class="font-bold text-gray-800">Puter</span>
                <span
                  class="text-[10px] bg-cyan-100 text-cyan-700 px-2 py-0.5 rounded-full font-medium"
                  >Backup 4 (Free)</span
                >
              </div>
              <button
                @click="resetProvider('puter')"
                class="text-xs bg-white hover:bg-gray-50 text-gray-600 px-2 py-1 rounded shadow-sm transition"
                x-show="!aiStatus.puter?.available"
              >
                Reset
              </button>
            </div>
            <p
              class="text-xs font-medium"
              :class="aiStatus.puter?.available ? 'text-emerald-600' : 'text-red-600'"
              x-text="aiStatus.puter?.available ? '‚úì Available' : '‚úï Rate Limited'"
            ></p>
            <p
              class="text-[10px] text-gray-500 mt-1"
              x-show="!aiStatus.puter?.available && aiStatus.puter?.remainingCooldownSeconds > 0"
            >
              Retry in:
              <span
                class="font-bold"
                x-text="formatCooldown(aiStatus.puter?.remainingCooldownSeconds)"
              ></span>
            </p>
            <p
              class="text-[10px] text-gray-400 mt-1"
              x-show="aiStatus.puter?.lastError && !aiStatus.puter?.available"
              x-text="'Error: ' + aiStatus.puter?.lastError"
            ></p>
          </div>
        </div>

        <p class="text-[10px] text-gray-400 mt-3 text-center">
          Status diperbarui: <span x-text="aiStatusTimestamp || '-'"></span> ‚Ä¢
          Auto-refresh setiap 30 detik
        </p>
      </div>
    </div>

    <!-- Anti-Spam Protection Panel -->
    <div class="max-w-7xl mx-auto mb-8">
      <div class="glass-card rounded-2xl p-5 shadow-xl">
        <div class="flex items-center justify-between mb-4">
          <div class="flex items-center gap-2">
            <span class="text-2xl">üõ°Ô∏è</span>
            <h3 class="text-lg font-bold text-gray-800">
              Anti-Spam Protection
            </h3>
          </div>
          <div class="flex gap-2">
            <button
              @click="fetchAntiSpamStats"
              class="text-xs bg-gray-100 hover:bg-gray-200 text-gray-600 px-3 py-1 rounded-lg font-medium transition"
            >
              üîÑ Refresh
            </button>
            <button
              @click="resetAllRateLimits"
              class="text-xs bg-red-100 hover:bg-red-200 text-red-700 px-3 py-1 rounded-lg font-medium transition"
            >
              üßπ Reset All Limits
            </button>
          </div>
        </div>

        <!-- Anti-Spam Stats -->
        <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-4">
          <div class="p-3 rounded-xl bg-blue-50 border border-blue-200">
            <p class="text-[10px] font-bold text-blue-600 uppercase">
              API Requests
            </p>
            <p
              class="text-xl font-bold text-blue-800"
              x-text="antiSpamStats?.apiRequests || 0"
            ></p>
          </div>
          <div class="p-3 rounded-xl bg-purple-50 border border-purple-200">
            <p class="text-[10px] font-bold text-purple-600 uppercase">
              Socket Connections
            </p>
            <p
              class="text-xl font-bold text-purple-800"
              x-text="antiSpamStats?.socketConnections || 0"
            ></p>
          </div>
          <div class="p-3 rounded-xl bg-red-50 border border-red-200">
            <p class="text-[10px] font-bold text-red-600 uppercase">
              Blacklisted IPs
            </p>
            <p
              class="text-xl font-bold text-red-800"
              x-text="antiSpamStats?.blacklistedIPs || 0"
            ></p>
          </div>
          <div class="p-3 rounded-xl bg-amber-50 border border-amber-200">
            <p class="text-[10px] font-bold text-amber-600 uppercase">
              Blacklisted Users
            </p>
            <p
              class="text-xl font-bold text-amber-800"
              x-text="antiSpamStats?.blacklistedUsers || 0"
            ></p>
          </div>
        </div>

        <!-- Blacklist Management -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <!-- IP Blacklist -->
          <div class="p-4 rounded-xl bg-gray-50 border border-gray-200">
            <h4
              class="text-sm font-bold text-gray-700 mb-3 flex items-center gap-2"
            >
              üåê Blacklist IP
            </h4>
            <div class="flex gap-2 mb-3">
              <input
                type="text"
                x-model="newBlacklistIP"
                placeholder="Masukkan IP address..."
                class="flex-1 px-3 py-2 text-sm rounded-lg input-modern outline-none"
              />
              <button
                @click="addBlacklistIP"
                class="bg-red-600 hover:bg-red-700 text-white px-3 py-2 rounded-lg text-xs font-bold transition"
              >
                + Block
              </button>
            </div>
            <div class="max-h-32 overflow-y-auto">
              <template x-if="blacklistInfo?.ips?.length === 0">
                <p class="text-xs text-gray-400 text-center py-2">
                  Tidak ada IP yang di-blacklist
                </p>
              </template>
              <template x-for="ip in (blacklistInfo?.ips || [])" :key="ip">
                <div
                  class="flex items-center justify-between py-1 px-2 bg-white rounded-lg mb-1"
                >
                  <span
                    class="text-xs font-mono text-gray-700"
                    x-text="ip"
                  ></span>
                  <button
                    @click="removeBlacklistIP(ip)"
                    class="text-red-500 hover:text-red-700 text-xs font-bold"
                  >
                    ‚úï
                  </button>
                </div>
              </template>
            </div>
          </div>

          <!-- User Blacklist -->
          <div class="p-4 rounded-xl bg-gray-50 border border-gray-200">
            <h4
              class="text-sm font-bold text-gray-700 mb-3 flex items-center gap-2"
            >
              üë§ Blacklist WA User
            </h4>
            <div class="flex gap-2 mb-3">
              <input
                type="text"
                x-model="newBlacklistUserJid"
                placeholder="628xxxxxxxxxx@s.whatsapp.net"
                class="flex-1 px-3 py-2 text-sm rounded-lg input-modern outline-none"
              />
              <button
                @click="addBlacklistUser"
                class="bg-amber-600 hover:bg-amber-700 text-white px-3 py-2 rounded-lg text-xs font-bold transition"
              >
                + Block
              </button>
            </div>
            <div class="max-h-32 overflow-y-auto">
              <template x-if="blacklistInfo?.users?.length === 0">
                <p class="text-xs text-gray-400 text-center py-2">
                  Tidak ada user yang di-blacklist
                </p>
              </template>
              <template
                x-for="user in (blacklistInfo?.users || [])"
                :key="user.userJid"
              >
                <div
                  class="flex items-center justify-between py-1 px-2 bg-white rounded-lg mb-1"
                >
                  <div>
                    <span
                      class="text-xs font-mono text-gray-700"
                      x-text="user.userJid?.replace('@s.whatsapp.net', '')"
                    ></span>
                    <span
                      class="text-[10px] text-gray-400 ml-2"
                      x-text="user.reason"
                    ></span>
                  </div>
                  <button
                    @click="removeBlacklistUser(user.sessionId, user.userJid)"
                    class="text-amber-500 hover:text-amber-700 text-xs font-bold"
                  >
                    ‚úï
                  </button>
                </div>
              </template>
            </div>
          </div>
        </div>

        <p class="text-[10px] text-gray-400 mt-3 text-center">
          Rate Limit: API 100 req/min ‚Ä¢ Message 30/min/session ‚Ä¢ Auth 10/15min ‚Ä¢
          Socket 10 conn/IP
        </p>
      </div>
    </div>

    <!-- Filter & Search -->
    <div class="max-w-7xl mx-auto mb-6">
      <div class="glass-card rounded-2xl p-4 shadow-xl">
        <div class="flex flex-col md:flex-row gap-4 items-center">
          <div class="flex-1 w-full">
            <div class="relative">
              <svg
                xmlns="http://www.w3.org/2000/svg"
                class="h-5 w-5 absolute left-4 top-1/2 -translate-y-1/2 text-gray-400"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"
                />
              </svg>
              <input
                type="text"
                x-model="searchQuery"
                placeholder="Cari email atau session ID..."
                class="w-full pl-12 pr-4 py-3 rounded-xl input-modern outline-none"
              />
            </div>
          </div>
          <div class="flex gap-2 flex-wrap">
            <button
              @click="filterStatus = 'all'"
              class="px-4 py-2 rounded-lg text-sm font-bold transition"
              :class="filterStatus === 'all' ? 'bg-indigo-600 text-white' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'"
            >
              Semua
            </button>
            <button
              @click="filterStatus = 'active'"
              class="px-4 py-2 rounded-lg text-sm font-bold transition"
              :class="filterStatus === 'active' ? 'bg-emerald-600 text-white' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'"
            >
              Active
            </button>
            <button
              @click="filterStatus = 'expiring'"
              class="px-4 py-2 rounded-lg text-sm font-bold transition"
              :class="filterStatus === 'expiring' ? 'bg-amber-600 text-white' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'"
            >
              Expiring
            </button>
            <button
              @click="filterStatus = 'expired'"
              class="px-4 py-2 rounded-lg text-sm font-bold transition"
              :class="filterStatus === 'expired' ? 'bg-red-600 text-white' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'"
            >
              Expired
            </button>
          </div>
          <select
            x-model="sortBy"
            class="px-4 py-3 rounded-xl input-modern outline-none text-sm font-medium"
          >
            <option value="newest">Terbaru</option>
            <option value="oldest">Terlama</option>
            <option value="expiring_soon">Expiring Soon</option>
            <option value="name_asc">A-Z</option>
          </select>
        </div>
      </div>
    </div>

    <!-- Users Table -->
    <div class="max-w-7xl mx-auto">
      <div class="glass-card rounded-2xl shadow-xl overflow-hidden">
        <!-- Table Header -->
        <div
          class="hidden md:grid grid-cols-12 gap-4 p-4 bg-gray-50 border-b border-gray-100 text-xs font-bold text-gray-500 uppercase tracking-wider"
        >
          <div class="col-span-3">User</div>
          <div class="col-span-2">Session ID</div>
          <div class="col-span-2">Status</div>
          <div class="col-span-2">Sisa Waktu</div>
          <div class="col-span-3 text-right">Aksi</div>
        </div>

        <!-- Table Body -->
        <div class="divide-y divide-gray-100">
          <template x-for="user in filteredUsers" :key="user.id">
            <div
              class="user-row grid grid-cols-1 md:grid-cols-12 gap-4 p-4 items-center"
            >
              <!-- User Info -->
              <div class="col-span-3 flex items-center gap-3">
                <div
                  class="w-10 h-10 rounded-full flex items-center justify-center text-white font-bold text-sm"
                  :class="user.role === 'DEVELOPER' ? 'bg-gradient-to-r from-purple-500 to-pink-500' : 'bg-gradient-to-r from-blue-500 to-indigo-500'"
                  x-text="user.email.charAt(0).toUpperCase()"
                ></div>
                <div>
                  <p
                    class="font-bold text-gray-800 text-sm"
                    x-text="user.email"
                  ></p>
                  <p class="text-xs text-gray-400">
                    <span
                      x-text="user.role === 'DEVELOPER' ? 'üëë Developer' : 'üë§ User'"
                    ></span>
                  </p>
                </div>
              </div>

              <!-- Session ID -->
              <div class="col-span-2 md:block hidden">
                <span
                  class="text-sm font-mono bg-gray-100 px-2 py-1 rounded text-gray-600"
                  x-text="user.waSessionId"
                ></span>
              </div>

              <!-- Status -->
              <div class="col-span-2 flex items-center gap-2">
                <span
                  class="status-badge"
                  :class="{
                  'status-active': user.status === 'ACTIVE',
                  'status-expired': user.status === 'EXPIRED',
                  'status-expiring': user.status === 'EXPIRING_SOON',
                  'status-unlimited': user.status === 'UNLIMITED'
                }"
                  x-text="user.status === 'EXPIRING_SOON' ? 'EXPIRING' : user.status"
                >
                </span>
              </div>

              <!-- Countdown -->
              <div class="col-span-2">
                <template x-if="user.status === 'UNLIMITED'">
                  <span class="text-purple-600 font-bold text-sm"
                    >‚ôæÔ∏è Unlimited</span
                  >
                </template>
                <template x-if="user.status !== 'UNLIMITED'">
                  <div class="flex items-center gap-2">
                    <div class="countdown-ring">
                      <svg viewBox="0 0 60 60">
                        <circle
                          cx="30"
                          cy="30"
                          r="26"
                          fill="none"
                          stroke="#E5E7EB"
                          stroke-width="6"
                        />
                        <circle
                          class="progress"
                          cx="30"
                          cy="30"
                          r="26"
                          fill="none"
                          :stroke="user.remainingDays <= 0 ? '#EF4444' : (user.remainingDays <= 3 ? '#F59E0B' : '#10B981')"
                          stroke-width="6"
                          :stroke-dasharray="(Math.min(user.remainingDays || 0, 30) / 30 * 163) + ' 163'"
                        />
                      </svg>
                      <div
                        class="absolute inset-0 flex items-center justify-center"
                      >
                        <span
                          class="text-xs font-bold"
                          x-text="user.remainingDays || 0"
                        ></span>
                      </div>
                    </div>
                    <div>
                      <p
                        class="text-sm font-bold text-gray-800"
                        x-text="(user.remainingDays || 0) + ' hari'"
                      ></p>
                      <p
                        class="text-[10px] text-gray-400"
                        x-text="user.expiryDate ? new Date(user.expiryDate).toLocaleDateString('id-ID') : '-'"
                      ></p>
                    </div>
                  </div>
                </template>
              </div>

              <!-- Actions -->
              <div class="col-span-3 flex justify-end gap-2 flex-wrap">
                <button
                  @click="openEditModal(user)"
                  class="action-btn bg-indigo-100 hover:bg-indigo-200 text-indigo-700 px-3 py-2 rounded-lg text-xs font-bold flex items-center gap-1"
                >
                  <svg
                    xmlns="http://www.w3.org/2000/svg"
                    class="h-4 w-4"
                    fill="none"
                    viewBox="0 0 24 24"
                    stroke="currentColor"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"
                    />
                  </svg>
                  Edit Waktu
                </button>
                <button
                  @click="toggleRole(user)"
                  class="action-btn px-3 py-2 rounded-lg text-xs font-bold flex items-center gap-1"
                  :class="user.role === 'DEVELOPER' ? 'bg-amber-100 hover:bg-amber-200 text-amber-700' : 'bg-purple-100 hover:bg-purple-200 text-purple-700'"
                >
                  <svg
                    xmlns="http://www.w3.org/2000/svg"
                    class="h-4 w-4"
                    fill="none"
                    viewBox="0 0 24 24"
                    stroke="currentColor"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M9 12l2 2 4-4M7.835 4.697a3.42 3.42 0 001.946-.806 3.42 3.42 0 014.438 0 3.42 3.42 0 001.946.806 3.42 3.42 0 013.138 3.138 3.42 3.42 0 00.806 1.946 3.42 3.42 0 010 4.438 3.42 3.42 0 00-.806 1.946 3.42 3.42 0 01-3.138 3.138 3.42 3.42 0 00-1.946.806 3.42 3.42 0 01-4.438 0 3.42 3.42 0 00-1.946-.806 3.42 3.42 0 01-3.138-3.138 3.42 3.42 0 00-.806-1.946 3.42 3.42 0 010-4.438 3.42 3.42 0 00.806-1.946 3.42 3.42 0 013.138-3.138z"
                    />
                  </svg>
                  <span
                    x-text="user.role === 'DEVELOPER' ? 'Demote' : 'Promote'"
                  ></span>
                </button>
                <button
                  @click="confirmDelete(user)"
                  class="action-btn bg-red-100 hover:bg-red-200 text-red-700 px-3 py-2 rounded-lg text-xs font-bold"
                >
                  üóëÔ∏è
                </button>
              </div>
            </div>
          </template>

          <!-- Empty State -->
          <div
            x-show="filteredUsers.length === 0"
            class="p-12 text-center text-gray-400"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              class="h-12 w-12 mx-auto mb-4 opacity-50"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4"
              />
            </svg>
            <p class="font-medium">Tidak ada user ditemukan</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Edit Modal -->
    <div
      x-show="showEditModal"
      x-transition
      x-cloak
      class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/50 backdrop-blur-sm"
    >
      <div
        class="glass-card rounded-2xl w-full max-w-md p-6 shadow-2xl"
        @click.outside="showEditModal = false"
      >
        <div class="flex justify-between items-center mb-6">
          <h3 class="text-lg font-bold text-gray-800">‚è∞ Edit Subscription</h3>
          <button
            @click="showEditModal = false"
            class="text-gray-400 hover:text-gray-600"
          >
            ‚úï
          </button>
        </div>

        <div class="mb-6">
          <p class="text-sm text-gray-600 mb-2">User:</p>
          <p class="font-bold text-gray-800" x-text="selectedUser?.email"></p>
          <p class="text-xs text-gray-400 mt-1">
            Sisa:
            <span
              class="font-bold"
              x-text="(selectedUser?.remainingDays || 0) + ' hari'"
            ></span>
          </p>
        </div>

        <!-- Quick Actions -->
        <div class="grid grid-cols-3 gap-2 mb-6">
          <button
            @click="quickAdd(7)"
            class="bg-emerald-100 hover:bg-emerald-200 text-emerald-700 py-3 rounded-xl font-bold text-sm transition"
          >
            +7 Hari
          </button>
          <button
            @click="quickAdd(30)"
            class="bg-emerald-100 hover:bg-emerald-200 text-emerald-700 py-3 rounded-xl font-bold text-sm transition"
          >
            +30 Hari
          </button>
          <button
            @click="quickAdd(90)"
            class="bg-emerald-100 hover:bg-emerald-200 text-emerald-700 py-3 rounded-xl font-bold text-sm transition"
          >
            +90 Hari
          </button>
        </div>

        <!-- Custom Input -->
        <div class="mb-6">
          <label class="block text-xs font-bold text-gray-600 mb-2"
            >Custom Waktu (hari)</label
          >
          <div class="flex gap-2">
            <input
              type="number"
              x-model="customDays"
              min="1"
              placeholder="30"
              class="flex-1 px-4 py-3 rounded-xl input-modern outline-none"
            />
            <button
              @click="customAdd"
              class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-3 rounded-xl font-bold transition"
            >
              + Tambah
            </button>
            <button
              @click="customSubtract"
              class="bg-red-600 hover:bg-red-700 text-white px-4 py-3 rounded-xl font-bold transition"
            >
              - Kurang
            </button>
          </div>
        </div>

        <!-- Set Unlimited -->
        <button
          @click="setUnlimited"
          class="w-full bg-gradient-to-r from-purple-500 to-pink-500 text-white py-3 rounded-xl font-bold hover:shadow-lg transition"
        >
          ‚ôæÔ∏è Set Unlimited
        </button>
      </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div
      x-show="showDeleteModal"
      x-transition
      x-cloak
      class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/50 backdrop-blur-sm"
    >
      <div
        class="glass-card rounded-2xl w-full max-w-sm p-6 shadow-2xl text-center"
        @click.outside="showDeleteModal = false"
      >
        <div class="text-5xl mb-4">‚ö†Ô∏è</div>
        <h3 class="text-lg font-bold text-gray-800 mb-2">Hapus User?</h3>
        <p class="text-sm text-gray-600 mb-6">
          Yakin ingin menghapus
          <span class="font-bold" x-text="userToDelete?.email"></span>? Semua
          data akan hilang.
        </p>
        <div class="flex gap-3">
          <button
            @click="showDeleteModal = false"
            class="flex-1 bg-gray-100 hover:bg-gray-200 text-gray-700 py-3 rounded-xl font-bold transition"
          >
            Batal
          </button>
          <button
            @click="deleteUser"
            class="flex-1 bg-red-600 hover:bg-red-700 text-white py-3 rounded-xl font-bold transition"
          >
            Hapus
          </button>
        </div>
      </div>
    </div>

    <!-- Loading Overlay -->
    <div
      x-show="isLoading"
      x-transition
      x-cloak
      class="fixed inset-0 z-50 flex items-center justify-center bg-black/30 backdrop-blur-sm"
    >
      <div class="glass-card rounded-2xl p-8 shadow-2xl text-center">
        <div
          class="animate-spin w-12 h-12 border-4 border-indigo-600 border-t-transparent rounded-full mx-auto mb-4"
        ></div>
        <p class="font-medium text-gray-700">Memproses...</p>
      </div>
    </div>

    <script>
      // ========================================
      // TOAST & CONFIRM UTILITY FUNCTIONS
      // ========================================
      function showToast(message, type = "info", title = "", duration = 3000) {
        const container = document.getElementById("toast-container");
        if (!container) return;

        const icons = { success: "‚úì", error: "‚úï", warning: "‚ö†", info: "‚Ñπ" };
        const titles = {
          success: "Berhasil!",
          error: "Error!",
          warning: "Perhatian!",
          info: "Informasi",
        };

        const toast = document.createElement("div");
        toast.className = `toast toast-${type}`;
        toast.innerHTML = `
          <div class="toast-icon">${icons[type] || icons.info}</div>
          <div class="toast-content">
            <div class="toast-title">${
              title || titles[type] || titles.info
            }</div>
            <div class="toast-message">${message}</div>
          </div>
          <button class="toast-close" onclick="this.parentElement.classList.add('removing'); setTimeout(() => this.parentElement.remove(), 300)">‚úï</button>
          <div class="toast-progress" style="animation-duration: ${duration}ms"></div>
        `;
        container.appendChild(toast);
        setTimeout(() => {
          if (toast.parentElement) {
            toast.classList.add("removing");
            setTimeout(() => toast.remove(), 300);
          }
        }, duration);
      }

      function showConfirm(options = {}) {
        return new Promise((resolve) => {
          const {
            title = "Konfirmasi",
            message = "Apakah Anda yakin?",
            type = "warning",
            confirmText = "Ya, Lanjutkan",
            cancelText = "Batal",
            icon = null,
          } = options;
          const icons = { warning: "‚ö†Ô∏è", danger: "üóëÔ∏è", info: "‚ùì" };

          const overlay = document.createElement("div");
          overlay.className = "confirm-modal-overlay";
          overlay.innerHTML = `
            <div class="confirm-modal">
              <div class="confirm-modal-header">
                <div class="confirm-modal-icon ${type}">${
            icon || icons[type] || icons.warning
          }</div>
                <div class="confirm-modal-title">${title}</div>
                <div class="confirm-modal-message">${message}</div>
              </div>
              <div class="confirm-modal-actions">
                <button class="confirm-modal-btn cancel">${cancelText}</button>
                <button class="confirm-modal-btn confirm ${
                  type === "danger" ? "danger" : ""
                }">${confirmText}</button>
              </div>
            </div>
          `;
          document.body.appendChild(overlay);

          const closeModal = (result) => {
            overlay.classList.add("removing");
            overlay.querySelector(".confirm-modal").classList.add("removing");
            setTimeout(() => {
              overlay.remove();
              resolve(result);
            }, 250);
          };

          overlay
            .querySelector(".confirm-modal-btn.cancel")
            .addEventListener("click", () => closeModal(false));
          overlay
            .querySelector(".confirm-modal-btn.confirm")
            .addEventListener("click", () => closeModal(true));
          overlay.addEventListener("click", (e) => {
            if (e.target === overlay) closeModal(false);
          });
          const handleEsc = (e) => {
            if (e.key === "Escape") {
              document.removeEventListener("keydown", handleEsc);
              closeModal(false);
            }
          };
          document.addEventListener("keydown", handleEsc);
        });
      }

      function developerDashboard() {
        return {
          users: [],
          searchQuery: "",
          filterStatus: "all",
          sortBy: "newest",
          showEditModal: false,
          showDeleteModal: false,
          selectedUser: null,
          userToDelete: null,
          customDays: 30,
          isLoading: false,

          // AI Provider Status
          aiStatus: {
            groq: {
              available: true,
              lastError: null,
              remainingCooldownSeconds: 0,
            },
            sambanova: {
              available: true,
              lastError: null,
              remainingCooldownSeconds: 0,
            },
            gemini: {
              available: true,
              lastError: null,
              remainingCooldownSeconds: 0,
            },
            openrouter: {
              available: true,
              lastError: null,
              remainingCooldownSeconds: 0,
            },
            puter: {
              available: true,
              lastError: null,
              remainingCooldownSeconds: 0,
            },
          },
          aiStatusTimestamp: null,
          aiStatusInterval: null,
          preferredProvider: "auto", // Manual AI provider selection

          // Anti-Spam Status
          antiSpamStats: null,
          blacklistInfo: { ips: [], users: [] },
          newBlacklistIP: "",
          newBlacklistUserJid: "",

          stats: {
            total: 0,
            active: 0,
            expiring: 0,
            expired: 0,
          },

          sessionId: localStorage.getItem("wa_session_id") || "",

          async init() {
            // First check localStorage
            const role = localStorage.getItem("user_role");
            if (!this.sessionId) {
              window.location.href = "/login.html";
              return;
            }

            if (role !== "DEVELOPER") {
              showToast(
                "Akses ditolak! Hanya Developer yang dapat mengakses halaman ini.",
                "error"
              );
              window.location.href = "/login.html";
              return;
            }

            // Validate with backend (prevents URL manipulation)
            const isValid = await this.validateDeveloperAccess();
            if (!isValid) {
              return;
            }

            await this.fetchUsers();

            // Fetch AI status and start auto-refresh
            await this.fetchAIStatus();
            this.aiStatusInterval = setInterval(
              () => this.fetchAIStatus(),
              30000
            );

            // Fetch Anti-Spam stats
            await this.fetchAntiSpamStats();

            // Fetch current preferred provider
            await this.fetchPreferredProvider();
          },

          async validateDeveloperAccess() {
            try {
              const res = await fetch("/api/developer/users", {
                headers: {
                  Authorization: `Bearer ${this.sessionId}`,
                },
              });

              if (res.status === 403) {
                showToast(
                  "‚õî Akses ditolak! Anda tidak memiliki hak akses Developer.",
                  "error"
                );
                localStorage.removeItem("user_role");
                window.location.href = "/login.html";
                return false;
              }

              if (res.status === 401) {
                showToast(
                  "‚õî Sesi tidak valid. Silakan login kembali.",
                  "error"
                );
                localStorage.clear();
                window.location.href = "/login.html";
                return false;
              }

              return res.ok;
            } catch (e) {
              console.error("Validation error:", e);
              return false;
            }
          },

          async fetchUsers() {
            this.isLoading = true;
            try {
              const res = await fetch("/api/developer/users", {
                headers: {
                  Authorization: `Bearer ${this.sessionId}`,
                },
              });
              const data = await res.json();

              if (data.code === "FORBIDDEN") {
                showToast("‚õî Akses ditolak!", "error");
                window.location.href = "/login.html";
                return;
              }

              if (data.status === "success") {
                this.users = data.data;
                this.calculateStats();
              }
            } catch (e) {
              console.error("Failed to fetch users:", e);
              showToast("Gagal memuat data user", "error");
            }
            this.isLoading = false;
          },

          calculateStats() {
            this.stats.total = this.users.length;
            this.stats.active = this.users.filter(
              (u) => u.status === "ACTIVE" || u.status === "UNLIMITED"
            ).length;
            this.stats.expiring = this.users.filter(
              (u) => u.status === "EXPIRING_SOON"
            ).length;
            this.stats.expired = this.users.filter(
              (u) => u.status === "EXPIRED"
            ).length;
          },

          get filteredUsers() {
            let result = [...this.users];

            // Filter by search
            if (this.searchQuery) {
              const query = this.searchQuery.toLowerCase();
              result = result.filter(
                (u) =>
                  u.email.toLowerCase().includes(query) ||
                  u.waSessionId.toLowerCase().includes(query)
              );
            }

            // Filter by status
            if (this.filterStatus !== "all") {
              const statusMap = {
                active: ["ACTIVE", "UNLIMITED"],
                expiring: ["EXPIRING_SOON"],
                expired: ["EXPIRED"],
              };
              const statuses = statusMap[this.filterStatus] || [];
              result = result.filter((u) => statuses.includes(u.status));
            }

            // Sort
            switch (this.sortBy) {
              case "oldest":
                result.sort(
                  (a, b) => new Date(a.createdAt) - new Date(b.createdAt)
                );
                break;
              case "expiring_soon":
                result.sort(
                  (a, b) => (a.remainingDays || 999) - (b.remainingDays || 999)
                );
                break;
              case "name_asc":
                result.sort((a, b) => a.email.localeCompare(b.email));
                break;
              default:
                result.sort(
                  (a, b) => new Date(b.createdAt) - new Date(a.createdAt)
                );
            }

            return result;
          },

          openEditModal(user) {
            this.selectedUser = user;
            this.customDays = 30;
            this.showEditModal = true;
          },

          async updateSubscription(action, days) {
            if (!this.selectedUser) return;

            this.isLoading = true;
            try {
              const res = await fetch("/api/developer/update-subscription", {
                method: "POST",
                headers: {
                  "Content-Type": "application/json",
                  Authorization: `Bearer ${this.sessionId}`,
                },
                body: JSON.stringify({
                  userId: this.selectedUser.id,
                  action: action,
                  days: days,
                }),
              });
              const data = await res.json();
              if (data.status === "success") {
                await this.fetchUsers();
                this.showEditModal = false;
                showToast("Subscription berhasil diupdate!", "success");
              } else {
                showToast(data.error || "Gagal update subscription", "error");
              }
            } catch (e) {
              console.error("Update error:", e);
              showToast("Terjadi kesalahan", "error");
            }
            this.isLoading = false;
          },

          quickAdd(days) {
            this.updateSubscription("add", days);
          },

          customAdd() {
            if (this.customDays > 0) {
              this.updateSubscription("add", this.customDays);
            }
          },

          customSubtract() {
            if (this.customDays > 0) {
              this.updateSubscription("subtract", this.customDays);
            }
          },

          setUnlimited() {
            this.updateSubscription("set_unlimited", 0);
          },

          async toggleRole(user) {
            const newRole = user.role === "DEVELOPER" ? "USER" : "DEVELOPER";
            const confirmMsg =
              newRole === "DEVELOPER"
                ? `Promosikan ${user.email} menjadi Developer?`
                : `Turunkan ${user.email} menjadi User biasa?`;

            const confirmed = await showConfirm({
              title:
                newRole === "DEVELOPER"
                  ? "Promosi ke Developer"
                  : "Demosi ke User",
              message: confirmMsg,
              type: "warning",
              icon: newRole === "DEVELOPER" ? "üëë" : "üë§",
              confirmText: "Ya, Lanjutkan",
              cancelText: "Batal",
            });
            if (!confirmed) return;

            this.isLoading = true;
            try {
              const res = await fetch("/api/developer/update-role", {
                method: "POST",
                headers: {
                  "Content-Type": "application/json",
                  Authorization: `Bearer ${this.sessionId}`,
                },
                body: JSON.stringify({
                  userId: user.id,
                  role: newRole,
                }),
              });
              const data = await res.json();
              if (data.status === "success") {
                await this.fetchUsers();
                showToast(`Role berhasil diubah menjadi ${newRole}`, "success");
              } else {
                showToast(data.error || "Gagal update role", "error");
              }
            } catch (e) {
              console.error("Role update error:", e);
              showToast("Terjadi kesalahan", "error");
            }
            this.isLoading = false;
          },

          confirmDelete(user) {
            this.userToDelete = user;
            this.showDeleteModal = true;
          },

          async deleteUser() {
            if (!this.userToDelete) return;

            this.isLoading = true;
            try {
              const res = await fetch(
                `/api/developer/delete-user/${this.userToDelete.id}`,
                {
                  method: "DELETE",
                  headers: {
                    Authorization: `Bearer ${this.sessionId}`,
                  },
                }
              );
              const data = await res.json();
              if (data.status === "success") {
                await this.fetchUsers();
                this.showDeleteModal = false;
                showToast("User berhasil dihapus", "success");
              } else {
                showToast(data.error || "Gagal menghapus user", "error");
              }
            } catch (e) {
              console.error("Delete error:", e);
              showToast("Terjadi kesalahan", "error");
            }
            this.isLoading = false;
          },

          // ========================================
          // AI PROVIDER STATUS METHODS
          // ========================================

          async fetchAIStatus() {
            try {
              const res = await fetch("/api/developer/ai-status", {
                headers: {
                  Authorization: `Bearer ${this.sessionId}`,
                },
              });
              const data = await res.json();
              if (data.status === "success") {
                this.aiStatus = data.data;
                this.aiStatusTimestamp = new Date(
                  data.timestamp
                ).toLocaleTimeString("id-ID");
              }
            } catch (e) {
              console.error("Failed to fetch AI status:", e);
            }
          },

          async resetProvider(provider) {
            try {
              const res = await fetch("/api/developer/ai-status/reset", {
                method: "POST",
                headers: {
                  "Content-Type": "application/json",
                  Authorization: `Bearer ${this.sessionId}`,
                },
                body: JSON.stringify({ provider }),
              });
              const data = await res.json();
              if (data.status === "success") {
                showToast(
                  `${provider.toUpperCase()} berhasil direset`,
                  "success"
                );
                await this.fetchAIStatus();
              } else {
                showToast(data.error || "Gagal reset provider", "error");
              }
            } catch (e) {
              console.error("Reset error:", e);
              showToast("Terjadi kesalahan", "error");
            }
          },

          async fetchPreferredProvider() {
            try {
              const res = await fetch("/api/developer/ai-provider", {
                headers: {
                  Authorization: `Bearer ${this.sessionId}`,
                },
              });
              const data = await res.json();
              if (data.status === "success") {
                this.preferredProvider = data.data.preferredProvider || "auto";
              }
            } catch (e) {
              console.error("Failed to fetch preferred provider:", e);
            }
          },

          async setPreferredProvider(provider) {
            try {
              const res = await fetch("/api/developer/ai-provider", {
                method: "POST",
                headers: {
                  "Content-Type": "application/json",
                  Authorization: `Bearer ${this.sessionId}`,
                },
                body: JSON.stringify({ provider }),
              });
              const data = await res.json();
              if (data.status === "success") {
                this.preferredProvider = data.preferredProvider || "auto";
                showToast(
                  provider === "auto"
                    ? "AI provider diset ke AUTO (fallback otomatis)"
                    : `AI provider diset ke ${provider.toUpperCase()}`,
                  "success"
                );
              } else {
                showToast(data.error || "Gagal set provider", "error");
                // Revert the select
                await this.fetchPreferredProvider();
              }
            } catch (e) {
              console.error("Set provider error:", e);
              showToast("Terjadi kesalahan", "error");
              await this.fetchPreferredProvider();
            }
          },

          async resetAllProviders() {
            const confirmed = await showConfirm({
              title: "Reset Semua Provider?",
              message:
                "Ini akan mereset status semua AI provider ke available.",
              type: "warning",
              icon: "‚ôªÔ∏è",
              confirmText: "Ya, Reset",
              cancelText: "Batal",
            });
            if (!confirmed) return;

            try {
              const res = await fetch("/api/developer/ai-status/reset", {
                method: "POST",
                headers: {
                  "Content-Type": "application/json",
                  Authorization: `Bearer ${this.sessionId}`,
                },
                body: JSON.stringify({ provider: "all" }),
              });
              const data = await res.json();
              if (data.status === "success") {
                showToast("Semua provider berhasil direset", "success");
                await this.fetchAIStatus();
              } else {
                showToast(data.error || "Gagal reset", "error");
              }
            } catch (e) {
              console.error("Reset all error:", e);
              showToast("Terjadi kesalahan", "error");
            }
          },

          // ========================================
          // ANTI-SPAM FUNCTIONS
          // ========================================

          async fetchAntiSpamStats() {
            try {
              const res = await fetch("/api/developer/antispam/stats", {
                headers: {
                  Authorization: `Bearer ${this.sessionId}`,
                },
              });
              const data = await res.json();
              if (data.status === "success") {
                this.antiSpamStats = data.data;
              }

              // Also fetch blacklist info
              const blacklistRes = await fetch(
                "/api/developer/antispam/blacklist",
                {
                  headers: {
                    Authorization: `Bearer ${this.sessionId}`,
                  },
                }
              );
              const blacklistData = await blacklistRes.json();
              if (blacklistData.status === "success") {
                this.blacklistInfo = blacklistData.data;
              }
            } catch (e) {
              console.error("Failed to fetch anti-spam stats:", e);
            }
          },

          async resetAllRateLimits() {
            const confirmed = await showConfirm({
              title: "Reset Semua Rate Limits?",
              message:
                "Ini akan menghapus semua tracking rate limit. Gunakan dengan hati-hati!",
              type: "danger",
              icon: "üßπ",
              confirmText: "Ya, Reset",
              cancelText: "Batal",
            });
            if (!confirmed) return;

            try {
              const res = await fetch("/api/developer/antispam/reset", {
                method: "POST",
                headers: {
                  "Content-Type": "application/json",
                  Authorization: `Bearer ${this.sessionId}`,
                },
              });
              const data = await res.json();
              if (data.status === "success") {
                showToast("Semua rate limits berhasil direset", "success");
                await this.fetchAntiSpamStats();
              } else {
                showToast(data.error || "Gagal reset", "error");
              }
            } catch (e) {
              console.error("Reset rate limits error:", e);
              showToast("Terjadi kesalahan", "error");
            }
          },

          async addBlacklistIP() {
            if (!this.newBlacklistIP.trim()) {
              showToast("Masukkan IP address", "warning");
              return;
            }

            try {
              const res = await fetch("/api/developer/antispam/blacklist/ip", {
                method: "POST",
                headers: {
                  "Content-Type": "application/json",
                  Authorization: `Bearer ${this.sessionId}`,
                },
                body: JSON.stringify({
                  ip: this.newBlacklistIP.trim(),
                  reason: "Manual via Dashboard",
                }),
              });
              const data = await res.json();
              if (data.status === "success") {
                showToast(
                  `IP ${this.newBlacklistIP} berhasil di-blacklist`,
                  "success"
                );
                this.newBlacklistIP = "";
                await this.fetchAntiSpamStats();
              } else {
                showToast(data.error || "Gagal blacklist IP", "error");
              }
            } catch (e) {
              console.error("Add blacklist IP error:", e);
              showToast("Terjadi kesalahan", "error");
            }
          },

          async removeBlacklistIP(ip) {
            try {
              const res = await fetch("/api/developer/antispam/blacklist/ip", {
                method: "DELETE",
                headers: {
                  "Content-Type": "application/json",
                  Authorization: `Bearer ${this.sessionId}`,
                },
                body: JSON.stringify({ ip }),
              });
              const data = await res.json();
              if (data.status === "success") {
                showToast(`IP ${ip} berhasil di-unblacklist`, "success");
                await this.fetchAntiSpamStats();
              } else {
                showToast(data.error || "Gagal unblacklist IP", "error");
              }
            } catch (e) {
              console.error("Remove blacklist IP error:", e);
              showToast("Terjadi kesalahan", "error");
            }
          },

          async addBlacklistUser() {
            if (!this.newBlacklistUserJid.trim()) {
              showToast("Masukkan nomor WhatsApp", "warning");
              return;
            }

            // Format JID if needed
            let jid = this.newBlacklistUserJid.trim();
            if (!jid.includes("@")) {
              jid = jid.replace(/\D/g, "") + "@s.whatsapp.net";
            }

            try {
              const res = await fetch(
                "/api/developer/antispam/blacklist/user",
                {
                  method: "POST",
                  headers: {
                    "Content-Type": "application/json",
                    Authorization: `Bearer ${this.sessionId}`,
                  },
                  body: JSON.stringify({
                    sessionId: this.sessionId,
                    userJid: jid,
                    reason: "Manual via Dashboard",
                    duration: 24, // 24 hours
                  }),
                }
              );
              const data = await res.json();
              if (data.status === "success") {
                showToast(
                  `User ${jid} berhasil di-blacklist (24 jam)`,
                  "success"
                );
                this.newBlacklistUserJid = "";
                await this.fetchAntiSpamStats();
              } else {
                showToast(data.error || "Gagal blacklist user", "error");
              }
            } catch (e) {
              console.error("Add blacklist user error:", e);
              showToast("Terjadi kesalahan", "error");
            }
          },

          async removeBlacklistUser(sessionId, userJid) {
            try {
              const res = await fetch(
                "/api/developer/antispam/blacklist/user",
                {
                  method: "DELETE",
                  headers: {
                    "Content-Type": "application/json",
                    Authorization: `Bearer ${this.sessionId}`,
                  },
                  body: JSON.stringify({ sessionId, userJid }),
                }
              );
              const data = await res.json();
              if (data.status === "success") {
                showToast(`User ${userJid} berhasil di-unblacklist`, "success");
                await this.fetchAntiSpamStats();
              } else {
                showToast(data.error || "Gagal unblacklist user", "error");
              }
            } catch (e) {
              console.error("Remove blacklist user error:", e);
              showToast("Terjadi kesalahan", "error");
            }
          },

          formatCooldown(seconds) {
            if (!seconds || seconds <= 0) return "0s";
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            if (mins > 0) {
              return `${mins}m ${secs}s`;
            }
            return `${secs}s`;
          },
        };
      }
    </script>
  </body>
</html>
