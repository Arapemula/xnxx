// prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
  output   = "../src/generated/client"
}

// INI BAGIAN YANG WAJIB ADA
datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

model Session {
  pkId      Int      @id @default(autoincrement())
  sessionId String
  id        String
  data      String   @db.LongText
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([sessionId, id], map: "unique_session_id_key")
  @@index([sessionId])
}

model User {
  id               Int       @id @default(autoincrement())
  email            String    @unique
  password         String
  waSessionId      String    @unique // ID Tim/Sesi WA (ex: cs_pagi)
  role             String    @default("USER") // USER atau DEVELOPER
  expiryDate       DateTime? // null = unlimited (untuk developer)
  hideCountdown    Boolean   @default(false) // preference untuk menyembunyikan countdown
  resetToken       String?
  resetTokenExpiry DateTime?
  createdAt        DateTime  @default(now())
}

model Chat {
  id            Int       @id @default(autoincrement())
  sessionId     String
  remoteJid     String
  name          String?
  label         String    @default("General")
  note          String?   @db.Text
  profilePicUrl String?   @db.Text
  messages      Message[]
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@unique([sessionId, remoteJid])
  @@index([sessionId])
}

model Message {
  id        Int      @id @default(autoincrement())
  chatId    Int
  chat      Chat     @relation(fields: [chatId], references: [id], onDelete: Cascade)
  keyId     String?
  fromMe    Boolean
  text      String?  @db.LongText
  mediaUrl  String?
  createdAt DateTime @default(now())
}

model Sale {
  id           Int      @id @default(autoincrement())
  sessionId    String
  itemName     String
  qty          Int
  price        Float
  customerJid  String?
  customerName String?
  date         DateTime @default(now())

  @@index([sessionId])
}

model Schedule {
  id          Int      @id @default(autoincrement())
  sessionId   String
  title       String
  description String?  @db.Text
  date        DateTime
  customerJid String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([sessionId])
}

// Email Verification Codes
model VerificationCode {
  id        Int      @id @default(autoincrement())
  email     String
  code      String
  type      String // "REGISTER" or "RESET_PASSWORD"
  expiresAt DateTime
  verified  Boolean  @default(false)
  createdAt DateTime @default(now())

  @@index([email, type])
}

// Scheduled Broadcasts
model ScheduledBroadcast {
  id            Int       @id @default(autoincrement())
  sessionId     String
  title         String
  message       String    @db.Text
  targetLabel   String    @default("all") // "all" or specific CRM label
  manualNumbers String?   @db.Text // comma-separated numbers for manual target
  scheduledAt   DateTime
  status        String    @default("PENDING") // PENDING, SENT, FAILED, CANCELLED
  sentAt        DateTime?
  sentCount     Int? // how many messages sent
  errorMessage  String?   @db.Text
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@index([sessionId])
  @@index([status])
  @@index([scheduledAt])
}

// Auto Reply (Quick Reply)
model AutoReply {
  id        Int      @id @default(autoincrement())
  sessionId String
  keyword   String
  response  String   @db.Text
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([sessionId, keyword])
  @@index([sessionId])
}
